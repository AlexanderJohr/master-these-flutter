\chapter{Schritt 6}
\label{chap:Schritt-6}


\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-6/Ü.png}
  {Der Übersichtsbildschirm in Schritt 6}
  {Der Übersichtsbildschirm in Schritt 6}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-6/D.png}
  {Die Eingabemaske in Schritt 6}
  {Die Eingabemaske in Schritt 6}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}


\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-6/D Z.png}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} können mehrere Optionen gewählt werden}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} können mehrere Optionen gewählt werden}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}

In diesem Schritt soll das Formular um Mehrfachauswahlfelder erweitert werden.
Im Speziellen handelt es sich um das Auswahlfeld Nebenziele.
Es beinhaltet die gleichen Auswahloptionen wie das Auswahlfeld Hauptzielsetzung.

\section{Integrationstest erweitern}

Zunächst wird der Integrationstest um die Auswahl der Nebenziele erweitert \Lst{\ref{lst:Schritt6tabSelectionCard}}.

\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/integration_test/app_test.dart}
  {firstline=118, lastline=127, highlightlines={121-123}}
  \label{lst:Schritt6tabSelectionCard}
\end{alexlisting}

Zu diesem Zweck löst der Test nach der Auswahl der Hauptzielsetzung \Z{118-119} nun einen Klick auf die Selektionskarte für die Nebenzielsetzung aus \Z{121}.
Dadurch öffnet sich der Auswahlbildschirm,
in welchem die Option \enquote{Bodenschutz} \Z{122} und anschließend die Option \enquote{Klima} \Z{123} gewählt wird.
Mit Auswahl der letzten Option
und durch die damit verbundene Übergabe des Arguments \IC{true} für den optionalen Parameter \IC{tabConfirm} wird der Auswahlbildschirm umgehend wieder geschlossen.
Anschließend erfolgt erneut das Speichern der Maßnahme \Z{125-126}.



Anders als bei den bisherigen Schlüssel-Werte-Paaren innerhalb des Objektes \IC{'massnahmenCharakteristika'} kann der Wert der Nebenziele nicht als einzelner String gespeichert werden \Lst{\ref{lst:Schritt6expectedJson}}.

\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/integration_test/app_test.dart}
  {firstline=136, lastline=150, highlightlines={140-143}}
  \label{lst:Schritt6expectedJson}
\end{alexlisting}

Bei dem Inhalt der Mehrfachauswahlfelder handelt es sich schließlich um eine Auflistung mehrerer Werte.
Sie wird im erwarteten JSON-Dokument als Array-Literal codiert \Z{140-143}.



\section{Hinzufügen der Menge der Nebenziele}

Für die Menge der Nebenziele müssen keine weiteren Auswahloptionen hinzugefügt werden.
Es werden die gleichen Optionen verwendet,
die auch bei der Menge  mit dem Namen \enquote{Hauptzielsetzung Land} zum Einsatz kommen \LstZ{\ref{lst:Schritt6nebenzielsetzungLandChoices}}{123-124}.

\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/lib/choices/choices.dart}
  {firstline=219, lastline=224, highlightlines={223-224}}
  \label{lst:Schritt6nebenzielsetzungLandChoices}
\end{alexlisting}

\section{Aktualisierung des \enquote{Models}}

Um die Liste der Nebenziele im Wertetyp \IC{MassnahmenCharakteristika} einzufügen,
kann der Datentyp \IC{BuiltSet} verwendet werden \LstZ{\ref{lst:Schritt6MassnahmenCharakteristika}}{77}.
\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/lib/data_model/massnahme.dart}
  {firstline=68, lastline=77, highlightlines={77}}
  \label{lst:Schritt6MassnahmenCharakteristika}
\end{alexlisting}
Die Getter-Methode \IC{nebenziele} bedarf keiner Null-Zulässigkeit,
da das Nicht-Vorhandensein von Werten darüber erreicht werden kann,
dass die Menge leer ist.




\section{Aktualisierung der Übersichtstabelle}

Für das Einfügen der Überschrift in der Übersichtstabelle gibt es keine Unterschiede zum bisherigen Vorgehen.
Die Überschrift wird nach der Spaltenüberschrift für die \enquote{Hauptzielsetzung} eingefügt \LstZ{\ref{lst:Schritt6buildColumnHeader}}{28}.

\begin{alexlisting}{Schritt 6}{XXXXX}
  {Quellcode/Schritt-6/conditional_form/lib/widgets/massnahmen_table.dart}
  {firstline=27, lastline=28, highlightlines={28}}
  \label{lst:Schritt6buildColumnHeader}
\end{alexlisting}

Die Anzeige der Werte in den TabellenZellen ist dagegen unterschiedlich \Lst{\ref{lst:Schritt6buildSelectableCell}}.
Dieses Mal handelt es sich um die Aufzählung von mehreren Werten,
weshalb ein \IC{Column}-Widget die einzelnen Einträge untereinander auflistet \Z{46-49}.
Jedes Element des \IC{BuiltSet} \IC{nebenziele} \Z{47} wird über die Methode \IC{map} jeweils in ein Element des Widgets \IC{Text} konvertiert \Z{48}.

\begin{alexlisting}{Schritt 6}{XXXXX}
  {Quellcode/Schritt-6/conditional_form/lib/widgets/massnahmen_table.dart}
  {firstline=42, lastline=50, highlightlines={44-50}}
  \label{lst:Schritt6buildSelectableCell}
\end{alexlisting}

\section{Aktualisierung des \enquote{ViewModels}}

Die Nebenziele werden -- erneut Mit dem Datentyp BuiltSet -- im \enquote{ViewModel} hinzugefügt \Lst{\ref{lst:Schritt6BehaviorSubjectNebenziele}}.
\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=18, lastline=21, highlightlines={20-21}}
  \label{lst:Schritt6BehaviorSubjectNebenziele}
\end{alexlisting}

Der benannte Konstruktor \IC{seeded} initialisiert die Instanzvariable mit  einer leeren Menge \Z{20}.
Dafür wird der parameterlose Konstruktor von \IC{BuiltSet} aufgerufen \Z{21}.
Dadurch unterscheidet sich das \IC{BehaviorSubject} von den anderen im \enquote{ViewModel}
und muss dementsprechend bei der Konvertierung zwischen \enquote{Model} in \enquote{ViewModel} gesondert behandelt werden.

Bei Konvertierung von \enquote{Model} in \enquote{ViewModel} sind für alle Auswahloptionen -- genau wie in den Schritten zuvor -- jeweils nur die Abkürzungen verfügbar.
Die Liste der gespeicherten Abkürzungen der Nebenziele muss dementsprechend zuerst in eine Menge von Auswahloptionen konvertiert werden,
bevor sie dem \IC{BuiltSet} übergeben werden kann \Lst{\ref{lst:Schritt6setModel}}.
Die Methode \IC{map} löst das Problem,
indem sie die ihr als Argument übergebene Funktion für jede Abkürzung in der Menge \enquote{Nebenziele} aufruft \Z{65}.
Die übergebene anonyme Funktion konvertiert die Abkürzung in die zugehörige Auswahloption.
Die resultierende Menge kann dem Konstruktor von \IC{BuiltSet} übergeben werden \Z{64-65}.

\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=46, lastline=67, highlightlines={64-65}}
  \label{lst:Schritt6setModel}
\end{alexlisting}


Ähnlich verhält es sich bei der Umwandlung des \enquote{ViewModels} in das \enquote{Model} \Lst{\ref{lst:Schritt6nebenzieleSetBuilder}}.

\begin{alexlisting}{Schritt 6}{XXXX}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=69, lastline=81, highlightlines={80-81}}
  \label{lst:Schritt6nebenzieleSetBuilder}
\end{alexlisting}

In diesem Fall muss die Menge der Auswahloptionen der \enquote{Nebenziele} in die entsprechenden Abkürzungen umgewandelt werden,
bevor sie im \enquote{Model} gespeichert wird.
Die Methode \IC{map} er hält zu diesem Zweck erneut eine anonyme Funktion,
welche die Abkürzung der Auswahloptionen abfragt \Z{81}.
Die resultierende Menge wird als Parameter dem Konstruktor \IC{SetBuilder} übergeben \Z{80-81}.
Der \IC{SetBuilder} wiederum kümmert sich um das Bauen des \IC{BuiltSet}, sobald ein Objekt des Typs Massnahme gebaut wird.



\section{Aktualisierung der Eingabemaske}

Unterhalb des Auswahlfeldes für das Hauptziel wird die Selektionkarte für die Nebenziele eingefügt \Lst{\ref{lst:Schritt6buildMultiSelectionCardnebenzielsetzungLandChoices}}.
\begin{alexlisting}{Schritt 6}{Der Aufruf von \enquote{buildMultiSelectionCard} für die Menge \enquote{nebenzielsetzungLandChoices}}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=212, lastline=217, highlightlines={215-217}}
  \label{lst:Schritt6buildMultiSelectionCardnebenzielsetzungLandChoices}
\end{alexlisting}

Allerdings handelt es sich dieses Mal um ein Mehrfachauswahlfeld,
weshalb eine neue Methode namens \IC{buildMultiSelectionCard} aufgerufen wird \Z{215-217}.

Da nun zwei Methoden zum Erstellen von Elementen des Widgets \IC{SelectionCard} existieren,
ist es sinnvoll,
den Quellcode zu refaktorisieren,
um redundanten Code zu vermeiden.



Innerhalb der bereits vorhandenen Methode \IC{buildSelectionCard} wird die Routine,
welche für die Validierung das Formulares genutzt wird,
in eine neue Methode namens \IC{validateChoices} \LstZ{\ref{lst:Schritt6buildSelectionCard}}{123-128} ausgelagert.
\begin{alexlisting}{Schritt 6}{Die Methode \enquote{buildSelectionCard} in Schritt 6}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=119, lastline=129, highlightlines={123-128}}
  \label{lst:Schritt6buildSelectionCard}
\end{alexlisting}

Sie bekommt die Attribute für den Namen der Menge \Z{124},
die zu validierenden Optionen \Z{125-127}
und schließlich die bisher ausgewählten Optionen aller Auswahlfelder \Z{128} übergeben.
Die ausgelagerte Funktion ist in Anhang \ref{appendix:Schritt6Anhang} in Listing \ref{lst:Schritt6validateChoices} auf Seite \pageref{lst:Schritt6validateChoices} zu finden.


Für die Erstellung der Mehrfachauswahlfelder ist die Methode \IC{buildMultiSelectionCard} zuständig \Lst{\ref{lst:Schritt6buildMultiSelectionCard}}.

\begin{alexlisting}{Schritt 6}{Die Methode \enquote{buildMultiSelectionCard}}
  {Quellcode/Schritt-6/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=144, lastline=166}
  \label{lst:Schritt6buildMultiSelectionCard}
\end{alexlisting}

Das übergebene \IC{selectionViewModel} unterstützt mit dem Typometer \IC{BuiltSet} die Auswahl von mehreren Auswahloption \Z{146}.
Bei \IC{selectionViewModel} handelt es sich bereits um eine Menge. Für die Validierung \IC{150} sowie für die Übergabe des initialen Wertes an den Konstruktor der \IC{SelectionCard} \Z{157} ist eine Umwandlung in eine Menge daher nicht mehr nötig.
Dem Konstruktor \IC{SelectionCard} wird weiterhin über den Parameter \IC{multiSelection} mitgeteilt, dass mehr als eine Auswahl zum gewählt werden darf \Z{154}.
Die Methoden \IC{onSelect} und \IC{onDeselect} ersetzen nun nicht mehr den aktuell gespeicherten Wert über eine einfache Zuweisung.
Sie nutzen stattdessen die Methode \IC{rebuild} des \IC{BuiltSet} um ein Element mit Hilfe von \IC{add} hinzuzufügen \Z{160} bzw. mit \IC{remove} Elemente zu entfernen \Z{163}.
Der Methodenaufruf \IC{rebuild} sorgt jedoch nicht für das Hinzufügen oder Löschen am Original-Objekt, sondern erstellt eine Kopie der Liste mit der gewünschten Änderungen.
Deshalb erfolgt eine Zuweisung der Kopie zum Wert des \IC{BehaviorSubject}-Objekts, was wiederum das Auslösen eines neuen Ereignisses bewirkt \Z{158,161}.

\section{Aktualisierung der Selektionskarte}


Diese Selektionskarte wird um die Instanzvariable \IC{multiSelection} erweitert \LstZ{\ref{lst:Schritt6SelectionCard}}{17},
dessen Wert im Konstruktor übergeben wird \Z{27} aber auch ausgelassen werden kann, da der Standardwert \IC{false} angegeben ist.

\begin{alexlisting}{Schritt 6}{Die Klasse \enquote{SelectionCard} erhält die Instanzvariable \enquote{multiSelection}}
  {Quellcode/Schritt-6/conditional_form/lib/widgets/selection_card.dart}
  {firstline=15, lastline=27, highlightlines={17,27}}
  \label{lst:Schritt6SelectionCard}
\end{alexlisting}


Die Rückruffunktion \IC{onChanged} des CheckboxListTile unterscheidet schließlich zwischen Mehrfach- und Einzel-Selektion.
Sollte \IC{multiSelection} mit \IC{true} gesetzt sein \Z{133}, so erstellt die Methode \IC{rebuild} von \IC{BuiltSet} eine Kopie des aktuellen \enquote{ViewModels} der Selektionen.
In der anonymen Funktion,
welche für die Manipulationen an der Kopie genutzt wird,
wird in einer Fallunterscheidung überprüft,
ob das angewählte Element bereits selektiert ist \Z{136}.
Sollte das der Fall sein,
so wird diese bereits selektierte Option, die nun erneut angewählt wurde, mit der Methode \IC{remove} des Builder-Objekts aus dem \IC{BuiltSet} entfernt \Z{137}.
Anderenfalls war die Option nicht selektiert, weshalb sie mit der Methode \IC{add} hinzugefügt wird. 


\begin{alexlisting}{Schritt 6}{Die Mehrfachselektion wird dem \enquote{CheckboxListTile} hinzugefügt }
  {Quellcode/Schritt-6/conditional_form/lib/widgets/selection_card.dart}
  {firstline=124, lastline=154, highlightlines={133-142, 147}}
  \label{lst:Schritt6XXXX}
\end{alexlisting}