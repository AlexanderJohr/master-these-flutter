\chapter{Schritt 7 - Benutzerdefinierte Validierungsfunktionen}
\label{chap:Schritt-7}


Nachdem im letzten Schritt nun die Mehrfachauswahl für die \enquote{Nebenziele} hinzugefügt wurde,
soll in diesem Schritt die Möglichkeit geschaffen werden,
benutzerdefinierte Abhängigkeiten für Auswahloptionen anzugeben.
Denn die \enquote{Nebenziele} haben mehrere besondere Voraussetzungen:

Sollte das \enquote{Hauptziel} nicht gesetzt sein oder die Option \enquote{keine Angabe/Vorgabe} oder \enquote{bitte um Unterstützung} enthalten,
  so ist es nicht sinnvoll, dass ein tatsächliches \enquote{Nebenziel} gewählt wird.
  In diesem Fall kommen wiederum nur die Werte \enquote{keine Angabe/Vorgabe} oder \enquote{bitte um Unterstützung} infrage.

Sollte dagegen ein \enquote{Hauptziel} gesetzt sein, so darf das \enquote{Nebenziel} nicht die gleiche Option enthalten.
  Ist also beispielsweise für das \enquote{Hauptziel} \enquote{Biodiversität} ausgewählt \Abb{\ref{fig:Schritt4EingabemaskeDHBioDiv}},
  so darf die Option im Selektionsbildschirm für die \enquote{Nebenziele} nicht zur Verfügung stehen \Abb{\ref{fig:Schritt4EingabemaskeDNBiodiv}}.






\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-7/D H BioDiv.png}
  {Im Selektionsbildschirm für das \enquote{Hauptziel} ist \enquote{Biodiversität} ausgewählt}
  {Im Selektionsbildschirm für das \enquote{Hauptziel} ist \enquote{Biodiversität} ausgewählt}

  \label{fig:Schritt4EingabemaskeDHBioDiv}

\end{alexfigure}

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-7/D N Biodiv.png}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} kann \enquote{Biodiversität} nicht ausgewählt werden}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} kann \enquote{Biodiversität} nicht ausgewählt werden}

  \label{fig:Schritt4EingabemaskeDNBiodiv}

\end{alexfigure}

\clearpage
Das bedeutet auch,
dass wenn für die \enquote{Nebenziele} bereits \enquote{Biodiversität} ausgewählt war
und anschließend für das \enquote{Hauptziel} ebenfalls \enquote{Biodiversität} gewählt wird,
so muss die invalide Auswahl im Selektionsbildschirm der \enquote{Nebenziele} rot gekennzeichnet werden \Abb{\ref{fig:Schritt4EingabemaskeDNBiodivRot}}. 

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-7/D N Biodiv Rot.png}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} wird die selektierte invalide Option \enquote{Biodiversität} rot gekennzeichnet}
  {Im Selektionsbildschirm für die \enquote{Nebenziele} wird die selektierte invalide Option \enquote{Biodiversität} rot gekennzeichnet}

  \label{fig:Schritt4EingabemaskeDNBiodivRot}

\end{alexfigure}


\section{Aktualisierung der Selektionskarte}

Diese Bedingungen lassen sich nicht mit der Funktion \enquote{condition} der Basisklasse \enquote{Choice} lösen.
Denn das Argument \enquote{priorChoices},
welches der Funktion \enquote{condition} übergeben wird,
enthält zwar alle Auswahloptionen,
die im gesamten Formular gewählt wurden,
gibt aber keine Auskunft darüber,
von welchem Auswahlfeld sie stammen. 
Sollte also die Auswahloption \enquote{Biodiversität} in der Menge der \enquote{priorChoices} auftauchen,
so ist unklar,
ob sie im Auswahlfeld für das \enquote{Hauptziel} oder dem der \enquote{Nebenziele} gewählt wurde.

Wenn der Selektionskarte aber eine benutzerdefinierte Funktion übergeben werden könnte,
welche im aufrufenden Kontext auch Zugriff auf das \enquote{ViewModel} hat,
so könnte direkt auf die Auswahlfelder zugegriffen werden.
Zu diesem Zweck wird der Klasse \IC{SelectionCard} die Instanzvariable \IC{choiceMatcher} hinzugefügt \LstZ{\ref{lst:Schritt7SelectionCard}}{31}.
Ein Parameter des gleichen Namens wird den Hilfsmethoden \IC{buildSelectionCard} und \IC{buildMultiSelectionCard} übergeben, welche ihn unverändert an den Konstruktor der Klasse \IC{SelectionCard} weiterleiten.
Die entsprechenden Listings sind in Anhang \ref{appendix:Schritt7Anhang} auf den Seiten \pageref{lst:Schritt7AppendixbuildSelectionCard} und \pageref{lst:Schritt7buildMultiSelectionCard} zu finden.






\begin{alexlisting}{Schritt 7}{Der \enquote{choiceMatcher} wird der Klasse \enquote{SelectionCard} hinzugefügt}
  {Quellcode/Schritt-7/conditional_form/lib/widgets/selection_card.dart}
  {firstline=13, lastline=47, highlightlines={13-14, 16-18, 31, 41, 46}}
  \label{lst:Schritt7SelectionCard}
\end{alexlisting}


% \ifIncludeFigures
%   \begin{listing}[htbp]
%     \let\oldtheFancyVerbLine\theFancyVerbLine
%   \renewcommand\theFancyVerbLine{%
% \ifnum\value{FancyVerbLine}=23 
%   \setcounter{FancyVerbLine}{30}%\scriptsize\ldots
% \else\ifnum\value{FancyVerbLine}=35
%   \setcounter{FancyVerbLine}{40}%\scriptsize\ldots
% \else\ifnum\value{FancyVerbLine}=59
%   \setcounter{FancyVerbLine}{75}%\scriptsize\ldots
% \else
% \oldtheFancyVerbLine%
% \fi
% \fi
% \fi
% }
%     \begin{minted}[firstnumber=13, highlightlines={13-14, 16-18, 31, 41, 46}]{dart}
% typedef ChoiceMatcher<ChoiceType extends Choice> = bool Function(
%     ChoiceType choice, Set<Choice> priorChoices);

% bool defaultChoiceMatcherStrategy(Choice choice, Set<Choice> priorChoices) {
%   return choice.conditionMatches(priorChoices);
% }

% const confirmButtonTooltip = 'Auswahl übernehmen';

% class SelectionCard<ChoiceType extends Choice> extends StatelessWidget {
%   /* ... */
%   final ChoiceMatcher<ChoiceType> choiceMatcher;

%   SelectionCard(
%       {required this.title,
%       /* ... */
%       ChoiceMatcher<ChoiceType>? choiceMatcher,
%       this.errorText,
%       Key? key})
%       : selectionViewModel = BehaviorSubject<BuiltSet<ChoiceType>>.seeded(
%             BuiltSet.from(initialValue)),
%         this.choiceMatcher = choiceMatcher ?? defaultChoiceMatcherStrategy,
%         super(key: key);
% \end{minted}
%     \alexlistingcaption{Schritt 1}{Der \enquote{choiceMatcher} wird der Klasse \enquote{SelectionCard} hinzugefügt} {Quellcode/Schritt-7/conditional_form/lib/widgets/selection_card.dart}
    
%     \label{lst:Schritt7SelectionCard}
%   \end{listing}
% \fi


Der initialisierende Wert kann im Konstruktor gesetzt \Z{41},
aber auch ausgelassen werden,
da er nicht mit dem \enquote{required}-Schlüsselwort gekennzeichnet und damit nicht verpflichtend ist.
Doch aus diesem Grund kann der Parameter den Wert \enquote{null} annehmen,
weshalb er mit dem Suffix \IC{?} gekennzeichnet werden muss.
In der Initialisierungsliste erfolgt die Initialisierung der Instanzvariablen \IC{choiceMatcher} \Z{46}.
Sollte der im Konstruktor übergebene Parameter nicht \enquote{null} sein,
so wird er der Instanzvariablen zugewiesen.
Ist er aber \enquote{null},
so sorgt die \enquote{if-null Expression} dafür,
dass der Standardwert rechts von dem \IC{??} zugewiesen wird:
die Funktion \IC{defaultChoiceMatcherStrategy}.
Diese Funktion kapselt die Überprüfung der Abhängigkeiten
-- welche die Auswahloptionen  untereinander haben --
so wie sie in den letzten Schritten durchgeführt wurde \Z{16-18}.
Ihr wird die zu überprüfende Auswahloption \IC{choice}
sowie die Menge \IC{priorChoices} -- die mit allen bisher ausgewählten Auswahloptionen im Formular gefüllt ist --
übergeben \Z{16}.
Die Auswahloption \IC{choice} ruft
-- wie zuvor auch --
die Methode \IC{conditionMatches} auf
und übergibt ihr das Objekt \IC{priorChoices} \Z{17}.
Diese Implementierung soll immer dann verwendet werden, 
wenn kein benutzerdefinierter \IC{choiceMatcher} übergeben wurde.
An dem Namen \IC{defaultChoiceMatcherStrategy} wird offensichtlich, um welches Entwurfsmuster es sich hierbei handelt: das \enquote{Strategie}-Entwurfsmuster. 

\clearpage
\subsection{Strategie-Entwurfsmuster}

Das \enquote{Strategie}-Entwurfsmuster ist ein Verhaltensmuster der \enquote{Gang of Four}.
Es erlaubt Algorithmen zu kapseln und auszutauschen \footcite[Vgl.][S. 373]{gamma2009entwurfsmuster}.
Abbildung \ref{fig:UmlStrategie} zeigt das \enquote{UML}-Diagramm des \enquote{Strategie}-Entwurfsmusters. 

\ifIncludeFigures
  \begin{figure}[h]
    \centering

    \begin{tikzpicture}

      \umlclass[x=-0.5, y=0]{Kontext}{
      }{
      KontextSchnittstelle()
      }
      
      \umlclass[x=6,y=0]{Strategie}{
        }{
        \umlvirt{AlgorithmusSchnittstelle()}
        }
      \umlclass[x=0,y=-4]{KonkreteStrategieA}{
        }{
        AlgorithmusSchnittstelle()
        }
      \umlclass[x=5.0,y=-4]{KonkreteStrategieB}{
        }{
        AlgorithmusSchnittstelle()
        }
      \umlclass[x=10,y=-4]{KonkreteStrategieC}{
        }{
        AlgorithmusSchnittstelle()
        }
      
      
      
      \umlinherit[geometry=|-|]{KonkreteStrategieA}{Strategie}
      \umlinherit[geometry=-|]{KonkreteStrategieB}{Strategie}
      \umlinherit[geometry=|-|]{KonkreteStrategieC}{Strategie}
      
      \umluniaggreg[arg1=strategie, pos1=0.4]{Kontext}{Strategie}
      
  \end{tikzpicture}

    \caption[\enquote{UML}-Diagramm des \enquote{Strategie}-Entwurfsmusters]{\enquote{UML}-Diagramm des \enquote{Strategie}-Entwurfsmusters, Quelle: In Anlehnung an \citet[S. 374]{gamma2009entwurfsmuster}}
    \label{fig:UmlStrategie} 

  \end{figure}%
\fi

Die Typdefinition \IC{ChoiceMatcher} \Z{13-14} kann nach dem \enquote{Strategie}-Entwurfsmuster als die Schnittstelle namens \enquote{Strategie} interpretiert werden.
Sie definiert, welche Voraussetzung an die Schnittstelle gegeben ist.
In diesem Fall ist die Voraussetzung, dass es sich um eine Funktion mit dem Rückgabewert \IC{bool} handelt,
der als erstes Argument eine Auswahloption
-- der Parameterbezeichner lautet \IC{choice} --
und als zweites Argument eine Menge von Auswahloptionen
-- der Parameterbezeichner ist \IC{priorChoices} --
übergeben werden.
Sollte der Parameter \IC{choiceMatcher} gesetzt sein,
so tauscht er die standardmäßig genutzte \enquote{Strategie} \IC{defaultChoiceMatcherStrategy} durch die benutzerdefinierte \enquote{Strategie} aus \Z{46}.
Beide werden nach dem \enquote{Strategie}-Entwurfsmuster als \enquote{konkrete Strategien} bezeichnet.
Im Entwurfsmuster gibt es noch den Akteur \enquote{Kontext},
wobei es sich um die aufrufende Klasse handelt,
welche die \enquote{Strategien} verwendet.
In diesem Fall ist das die \enquote{Klasse} \IC{SelectionCard}.

Abbildung \ref{fig:UmlChoiceMatcherStrategyPattern} zeigt das \enquote{UML}-Diagramm der konkreten Implementierung des \enquote{Strategie}-Entwurfsmusters für die \enquote{Strategie} \enquote{ChoiceMatcher}.

\ifIncludeFigures
  \begin{figure}[h]
    \centering

    \begin{tikzpicture}

      \umlsimpleclass[x=-1, y=0]{SelectionCard}{}{}
      
      \umlsimpleclass[x=7,y=0]{ChoiceMatcher}{}{}
      \umlsimpleclass[x=0,y=-2.5]{nebenzieleChoiceMatcherStrategy}{}{}
      \umlsimpleclass[x=7,y=-2.5]{defaultChoiceMatcherStrategy}{}{}

      \umlsimpleclass[x=3.5, y=-4.5]{MassnahmenDetailScreen}{}{}
           
      \umlinherit[geometry=|-|]{nebenzieleChoiceMatcherStrategy}{ChoiceMatcher}
      \umlinherit[geometry=-|]{defaultChoiceMatcherStrategy}{ChoiceMatcher}
      
      \umluniaggreg[arg1=choiceMatcher, pos1=0.4]{SelectionCard}{ChoiceMatcher}
      
      \umluniassoc[geometry=-|]{MassnahmenDetailScreen}{defaultChoiceMatcherStrategy}

      \umldep[arg=<<create>>, pos=0.9, geometry=-|, anchors=180 and -150]{MassnahmenDetailScreen}{nebenzieleChoiceMatcherStrategy}


  \end{tikzpicture}

    \caption[\enquote{UML}-Diagramm des \enquote{Strategie}-Entwurfsmusters für den \enquote{ChoiceMatcher}]{\enquote{UML}-Diagramm des \enquote{Strategie}-Entwurfsmusters für den \enquote{ChoiceMatcher}, Quelle: Eigene Abbildung}
    \label{fig:UmlChoiceMatcherStrategyPattern}

  \end{figure}%
\fi

\section{Aktualisierung der Eingabemaske}

Im Diagramm ist ebenfalls der \enquote{View} \enquote{MassnahmenDetailScreen} enthalten,
denn er verwendet die \enquote{konkrete Strategie} \IC{defaultChoiceMatcherStrategy} für die Validierung \Lst{\ref{lst:Schritt7buildSelectionCard}}.
Sollte nämlich ein Argument für den Parameter \IC{choiceMatcher} übergeben werden \Z{122},
so wird es auch für die Validierung verwendet \Z{130}.
Ist das Argument aber nicht gesetzt und damit \enquote{null},
so sorgt die \enquote{if-null Expression} dafür,
dass die \IC{defaultChoiceMatcherStrategy} für die Validierung verwendet wird.

\begin{alexlisting}{Schritt 7}{Die Methode \enquote{buildSelectionCard} mit dem Parameter \enquote{choiceMatcher}}
  {Quellcode/Schritt-7/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=119, lastline=140, highlightlines={122,130}}
  \label{lst:Schritt7buildSelectionCard}
\end{alexlisting}

\clearpage

Außerdem erstellt \enquote{MassnahmenDetailScreen} die \enquote{konkrete Strategie} für die benutzerdefinierte Validierung der \enquote{Nebenziele}. Im \enquote{UML}-Diagramm wurde sie zum besseren Verständnis \enquote{nebenzieleChoiceMatcherStrategy} genannt. Im Listing \ref{lst:Schritt7buildMultiSelectionCardZielsetzungLandChoice} ist sie als anonyme Funktion zu sehen.
Im Aufruf \IC{buildMultiSelectionCard} für die \enquote{Nebenziele} wird sie dem Parameter \IC{choiceMatcher} übergeben \Z{224-238}.
In der ersten Fallunterscheidung wird überprüft,
ob die gewählte Option ein tatsächliches \enquote{Nebenziel} ist \Z{225}.
Das kann über die \enquote{Getter}-Methode \IC{hasRealValue} abgefragt werden.
Ist dies nicht der Fall,
so handelt es sich um die Auswahloptionen \enquote{keine Angabe/Vorgabe} bzw. \enquote{bitte um Unterstützung},
weshalb \IC{true} zurückgegeben werden kann \Z{237},
da diese Auswahloptionen immer erlaubt sind.
Sollte es sich dagegen um ein tatsächliches \enquote{Nebenziel} handeln,
so überprüft die nächste Fallunterscheidung,
ob das \enquote{Hauptziel} entweder nicht gesetzt ist
oder mit einem nicht tatsächlichen \enquote{Hauptziel} belegt ist \Z{226-228}.
Dazu wird die \enquote{Getter}-Methode \IC{hasNoRealValue} benutzt,
welche als Gegenteil zu \IC{hasRealValue} fungiert
und dementsprechend \enquote{true} zurückgibt, wenn die Auswahloption entweder \enquote{keine Angabe/Vorgabe} oder \enquote{bitte um Unterstützung} ist.
Sollte das \enquote{Hauptziel} keinen tatsächlichen Wert einer Zielsetzung enthalten,
dann ist die Wahl eines oder mehrerer \enquote{Nebenziele} nicht sinnvoll.
Waren beide bisherigen Bedingungen nicht wahr,
so steht bereits fest,
dass sowohl das \enquote{Hauptziel}
als auch die \enquote{Nebenziele} gesetzt sind.
Beide enthalten weder \enquote{keine Angabe/Vorgabe}
noch \enquote{bitte um Unterstützung} als Wert.
Nun soll eine letzte Fallunterscheidung überprüfen,
ob das \enquote{Nebenziel} bereits im \enquote{Hauptziel} gesetzt ist \Z{230-231}.
Das ist nicht erlaubt,
weshalb \IC{false} zurückgegeben werden soll \Z{232}.
Anderenfalls sind alle Bedingungen erfüllt und \IC{true} kann zurückgegeben werden \Z{234}.

An diesem Beispiel wird auch offensichtlich,
welchen Nutzen die Generalisierung der Klasse \enquote{SelectionCard} über den Typparameter \enquote{ChoiceType} hat.
Über eine Reihe von Methoden- und Konstruktoraufrufen gelangt das Typargument \IC{ZielsetzungLandChoice} in die Klasse \enquote{SelectionCard} und somit auch zu der Instanzvariablen \enquote{choiceMatcher}. Zuerst wird es der Methode \IC{buildMultiSelectionCard} übergeben \Z{221}. 
Mit dem Konstruktoraufruf \IC{SelectionCard<ChoiceType>} wird es an die Selektionskarte weitergereicht (Siehe Listing \ref{lst:Schritt7buildMultiSelectionCard} in Zeile 157 in Anhang \ref{appendix:Schritt7Anhang} auf Seite \pageref{lst:Schritt7buildMultiSelectionCard}).
Schließlich erhält die Instanzvariable das Typargument über die Deklaration \IC{ChoiceMatcher<ChoiceType> choiceMatcher} \LstSZ{lst:Schritt7SelectionCard}{31}.
Der Typparameter wird durch das Typargument ersetzt.
Somit hat \IC{choiceMatcher} dann den Typ \enquote{ChoiceMatcher<ZielsetzungLandChoice>}.
Damit handelt es sich also auch bei dem ersten Parameter \IC{choice} der anonymen Funktion --
die dem Parameter \IC{choiceMatcher} übergeben wird \LstZ{\ref{lst:Schritt7buildMultiSelectionCardZielsetzungLandChoice}}{224} -- um den Typ \IC{ZielsetzungLandChoice}.
Aus diesem Grund können die Methoden \IC{hasRealValue} \Z{225} und \IC{hasNoRealValue} \Z{228} auf dem Objekt \IC{choice} aufgerufen werden,
obwohl sie Teil der Klasse \IC{ZielsetzungLandChoice}, aber nicht der Basisklasse \enquote{Choice} sind.
Ohne Parametrisierung über den Typ müsste das Objekt \IC{choice} in einen anderen Typ umgewandelt werden.
Doch nach dieser Typumwandlung könnte ein Laufzeitfehler geschehen, sollte es sich bei dem Objekt tatsächlich nicht um den gewünschten Typ handeln.
Durch die Generalisierung der Klassen und die Angabe des Typarguments ist das Vorhandensein des richtigen Typs garantiert und keine Typumwandlung nötig.

\begin{alexlisting}{Schritt 7}{Der benutzerdefinierte \enquote{choiceMatcher} für die Menge \enquote{nebenzielsetzungLandChoices}}
  {Quellcode/Schritt-7/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=221, lastline=239, highlightlines={224-239}}
  \label{lst:Schritt7buildMultiSelectionCardZielsetzungLandChoice}
\end{alexlisting}

Die beiden neuen Methoden sind in Listing \ref{lst:Schritt7ZielsetzungLandChoice} zu sehen. \IC{hasRealValue} vergleicht, ob der aktuelle Wert weder \enquote{keine Angabe/Vorgabe} noch \enquote{bitte um Unterstützung} ist \Z{201}.
\IC{hasNoRealValue} ruft dagegen intern \IC{hasRealValue} auf und negiert den Wert \Z{203}.


\ifIncludeFigures
  \begin{listing}[htbp]
    \let\oldtheFancyVerbLine\theFancyVerbLine
    \renewcommand\theFancyVerbLine{%
      \ifnum\value{FancyVerbLine}=187
      \setcounter{FancyVerbLine}{197}
      %\scriptsize\ldots
      \else
      \oldtheFancyVerbLine%
      \fi
    }
    \begin{minted}[firstnumber=185, highlightlines={201,203}]{dart}
class ZielsetzungLandChoice extends Choice {
  static final ka = ZielsetzungLandChoice("ka", "keine Angabe/Vorgabe");
  /* ... */
  static final contact =
      ZielsetzungLandChoice("contact", "bitte um Unterstützung");

  bool get hasRealValue => this != ka && this != contact;

  bool get hasNoRealValue => !hasRealValue;
\end{minted}
    \alexlistingcaption{Schritt 7}{Die \enquote{Getter}-Methoden \enquote{hasRealValue} und \enquote{hasNoRealValue}} {Quellcode/Schritt-7/conditional_form/lib/choices/choices.dart}
    \label{lst:Schritt7ZielsetzungLandChoice}
  \end{listing}
\fi


%\begin{alexlisting}{Schritt 7}{XXX}
%  {Quellcode/Schritt-7/conditional_form/lib/choices/choices.dart}
%  {firstline=185, lastline=203, highlightlines={201,203}}
%  \label{lst:Schritt7ZielsetzungLandChoice}
%\end{alexlisting}





Überall dort, wo zuvor der Ausdruck \IC{choice.conditionMatches(priorChoices)} verwendet wurde, muss nun der Aufruf des \IC{choiceMatcher} erfolgen.
So zum Beispiel der \enquote{Stream}, welcher die Validität der Auswahlfelder prüft \Lst{\ref{lst:Schritt7validityChangedchoiceMatcher}}.
\begin{alexlisting}{Schritt 7}{Der \enquote{Stream} \enquote{validityChanged} in Schritt 7}
  {Quellcode/Schritt-7/conditional_form/lib/widgets/selection_card.dart}
  {firstline=63, lastline=66, highlightlines={65}}
  \label{lst:Schritt7validityChangedchoiceMatcher}
  \end{alexlisting}

Alle Vorkommnisse, die durch den neuen Ausdruck ersetzt werden,
sind im Anhang \ref{appendix:Schritt7Anhang} auf den Seiten \pageref{lst:Schritt7validityChangedStreamBuilderChoiceMatcher}
bis \pageref{lst:Schritt7validateChoices} zu finden.
