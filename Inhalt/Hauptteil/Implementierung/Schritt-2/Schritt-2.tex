\chapter{Schritt 2}
\label{chap:Schritt-2}



In diesem Schritt sollen weitere Selektions-Karten für die Einzelauswahlfelder hinzugefügt werden.
Es handelt sich um die Einzelauswahlfelder für Förderklasse, Kategorie, Zielfläche, Zieleinheit und Zielsetzung.
In der Eingabemaske sollen sie in einer Rubrik mit der Überschrift  Maßnahmencharakteristika auftauchen \Abb{\ref{fig:Schritt2Eingabemaske}}.

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-2/D.png}
  {Die Eingabemaske in Schritt 2}
  {Die Eingabemaske in Schritt 2}

  \label{fig:Schritt2Eingabemaske}

\end{alexfigure}

In den Tabellen im Übersichtsbildschirm erscheinen  die Werte  rechts  vom Maßnahmentitel \Abb{\ref{fig:Schritt2Uebersicht}}.
\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-2/Ü.png}
  {Der Übersichtsbildschirm in Schritt 2}
  {Der Übersichtsbildschirm in Schritt 2}

  \label{fig:Schritt2Uebersicht}

\end{alexfigure}

Darüber hinaus soll das Erstellen der Selektions-Karten in einer Methode abstrahiert werden.
Das ermöglicht die Konfiguration der Selektions-Karten in der aufrufenden Eingabemaske, ohne dafür die Klasse \IC{SelectionCard} ändern zu müssen.

\subsection{Integrationstest erweitern}

Noch vor der Implementierung der Änderungen soll zunächst der Integrationstest um die zusätzlichen Selektionen erweitert werden \Lst{\ref{lst:Schritt2IntegrationstestKlickt5WeitereKarten}}. Nach den letzten Eingaben und bevor der Button zum Speichern ausgelöst wird, erfolgt die Selektion der fünf Optionen \Z{106-119}.   

\begin{alexlisting}{Schritt 2}{Der Integrationstest klickt 5 weitere Karten}
  {Quellcode/Schritt-2/conditional_form/integration_test/app_test.dart}
  {firstline=106, lastline=123, highlightlines={106-119}}
  \label{lst:Schritt2IntegrationstestKlickt5WeitereKarten}
\end{alexlisting}

Nach der Auswahl und der anschließenden Serialisierung sollen die entsprechenden Werte auch in der JSON-Datei auftauchen.
Die JSON-Datei erhält ein neues Schlüssel-Werte-Paar mit dem Schlüssel \IC{'massnahmenCharakteristika'} und einem Objekt für die fünf neuen Werte \LstZ{\ref{lst:Schritt2ExpectedJson}}{135-141}.

\begin{alexlisting}{Schritt 2}{Der Integrationstest überprüft im \enquote{JSON}-Dokument den Schlussel \enquote{massnahmenCharakteristika}}
  {Quellcode/Schritt-2/conditional_form/integration_test/app_test.dart}
  {firstline=132, lastline=142, highlightlines={135-141}}
  \label{lst:Schritt2ExpectedJson}
\end{alexlisting}

Der Integrationstest ist damit aktualisiert.
Die Implementierung ist jedoch noch gar nicht erfolgt.
Die Selektions-Karten können nicht angeklickt werden, da sie in der Oberfläche noch nicht auftauchen.
Die neuen Schlüssel-Werte-Paare können nicht in der Hash-Tabelle auftauchen, da sie dem entsprechenden Wertetyp noch nicht hinzugefügt wurden.
Der Integrationstest kann also unmöglich erfolgreich sein.
Der Quellcode kann noch nicht einmal kompilieren, da die entsprechenden Symbole -- wie zum Beispiel \IC{FoerderklasseChoice} -- fehlen.
Das hier angewendete Vorgehensmodell wird Test-Driven Development -- deutsch Testgetriebene Entwicklung -- genannt.
 


\begin{quotation}
\textit{\enquote{Development is driven by tests.
You test first, then code.
Until all the tests run, you aren't
done.
When all the tests run, and you can't think of any more tests that would break, you
are done adding functionality.}}

\rightline{{ — Kent Beck\footcite[][S. 9]{beck2003test}}}

\end{quotation}

Es folgt das Hinzufügen der fehlenden Symbole, damit der Quellcode wieder kompiliert werden kann.
Anschließend erfolgt die Weiterentwicklung des \enquote{Models}, \enquote{ViewModels} und des \enquote{Views} damit der Integrationstest erneut erfolgreich abschließt.


\subsection{Hinzufügen der Auswahloptionen}

Der Integrationstest selektiert unter anderem die Förderklasse mit der Abkürzung \IC{aukm_ohne_vns}. Sie wird den Auswahloptionen hinzugefügt, wie in Listing \ref{lst:Schritt2KlasseFoerderklasseChoice} zu sehen ist.
Die Liste aller hinzugefügten Auswahloptionen in diesem Schritt ist im Anhang \ref{appendix:Schritt2Anhang} auf den Seiten \pageref{lst:Schritt2FoerderklasseChoicesKategorieChoices} bis \pageref{lst:Schritt2hauptzielsetzungLandChoices} zu finden.

\begin{alexlisting}{Schritt 2}{Die Klassenvariable \enquote{aukm_ohne_vns} vom Typ \enquote{FoerderklasseChoice}}
  {Quellcode/Schritt-2/conditional_form/lib/choices/choices.dart}
  {firstline=11, lastline=12}
  \label{lst:Schritt2KlasseFoerderklasseChoice}
\end{alexlisting}

\subsection{Aktualisierung des \enquote{Models}}

Damit der Hash-Tabelle der Schlüssel \IC{'massnahmenCharakteristika'} hinzugefügt wird, muss der entsprechende Eintrag im Wertetyp \IC{Massnahme} hinzugefügt werden.
Die Getter-Methode \IC{massnahmenCharakteristika}, die das Paket \enquote{built_value} dazu veranlasst, den Quellcode für die Eigenschaft zu generieren, wird unterhalb der Getter-Methode \IC{identifikatoren} hinzugefügt \LstZ{\ref{lst:Schritt2massnahmenCharakteristikaWirdMMassnahmeHinzugefuegt}}{15}.

\begin{alexlisting}{Schritt 2}{\enquote{massnahmenCharakteristika} wird dem Wertetyp \enquote{Massnahme} hinzugefügt}
  {Quellcode/Schritt-2/conditional_form/lib/data_model/massnahme.dart}
  {firstline=13, lastline=15, highlightlines={15}}
  \label{lst:Schritt2massnahmenCharakteristikaWirdMMassnahmeHinzugefuegt}
\end{alexlisting}

Bei dem Datentyp handelt es sich um einen weiteren Wertetyp: \IC{MassnahmenCharakteristika}, welcher in Listing \ref{lst:Schritt2WerteTypMassnahmencharakteristika} zu sehen ist.
Die darin enthaltenen Getter-Methoden sind dagegen lediglich gewöhnliche Zeichenketten, da sie die Abkürzungen der ausgewählten Optionen abspeichern.
Da sie auch im Entwurfsmodus nicht gefüllt sein können, wird ihnen mit dem Suffix \IC{?} erlaubt, Null-Werte anzunehmen \Z{70-74}.

\begin{alexlisting}{Schritt 2}{Der Wertetyp \enquote{Massnahmencharakteristika}}
  {Quellcode/Schritt-2/conditional_form/lib/data_model/massnahme.dart}
  {firstline=67, lastline=74}
  \label{lst:Schritt2WerteTypMassnahmencharakteristika}
\end{alexlisting}

Der Wertetyp wurde hinzugefügt.
Der Befehl \IC{flutter pub run build_runner build} generiert den Quellcode für die Serialisierung und die \enquote{Builder}-Methoden.

\subsection{Aktualisierung der Übersichtstabelle}

Der Übersichtsbildschirm bzw. die Übersichtstabelle können auf das \enquote{Model} ohne den Umweg über das \enquote{ViewModel} zugreifen. Der Tabellenkopf listet die Überschriften der hinzugefügten Werte auf \LstZ{\ref{lst:Schritt2MassnahmencharakteristikaEerdenDemTabellenkopfHinzugefuegt}}{23-27}.

\begin{alexlisting}{Schritt 2}{Die \enquote{Maßnahmencharakteristika} werden dem Tabellenkopf hinzugefügt}
  {Quellcode/Schritt-2/conditional_form/lib/widgets/massnahmen_table.dart}
  {firstline=22, lastline=27, highlightlines={23-27}}
  \label{lst:Schritt2MassnahmencharakteristikaEerdenDemTabellenkopfHinzugefuegt}
\end{alexlisting}

Für jede Zeile der Tabelle werden weitere selektierbare Zellen generiert \LstZ{\ref{lst:Schritt2MassnahmencharakteristikaWerdenDemTabellenkoerperHinzugefuegt}}{33-42}. Im Unterschied zur Zelle des Maßnahmen-Titels können die Getter-Methoden der Maßnahmen-Charakteristika jedoch Null-Werte enthalten.
Doch das \IC{Text}-Widget akzeptiert keine Null-Werte als Argument. Deshalb wird der Operator \IC{??} verwendet. Dabei handelt es sich um die \enquote{If-null Expression}. 
Sie überprüft den Ausdruck links vom Operator \IC{??}. Ist er \IC{null}, so wird der Wert rechts vom Operator verwendet.
Ist der dagegen nicht \IC{null}, so wird der Wert links vom Operator \IC{??} genutzt. \DartSpec{165} Ist der Wert also nicht gefüllt, so wird in allen Fällen der leere String \IC{""} als Argument übergeben.

\begin{alexlisting}{Schritt 2}{Die \enquote{Maßnahmencharakteristika} werden dem Tabellenkörper hinzugefügt}
  {Quellcode/Schritt-2/conditional_form/lib/widgets/massnahmen_table.dart}
  {firstline=32, lastline=42, highlightlines={33-42}}
  \label{lst:Schritt2MassnahmencharakteristikaWerdenDemTabellenkoerperHinzugefuegt}
\end{alexlisting}

\subsection{Aktualisierung des \enquote{ViewModels}}

Damit die Eingabefelder die neuen Werte eintragen können, muss das \enquote{ViewModel} die beobachtbaren \enquote{Subjects} bereitstellen \LstZ{\ref{lst:Schritt2MassnahmencharakteristikaWerdenDemViewModelHinzugefuegt}}{12-17}. \HP{Subjects und Observer in Schritt 1 erklären}

\begin{alexlisting}{Schritt 2}{Die \enquote{Maßnahmencharakteristika} werden dem \enquote{ViewModel} hinzugefügt}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=5, lastline=17, highlightlines={12-17}}
  \label{lst:Schritt2MassnahmencharakteristikaWerdenDemViewModelHinzugefuegt}
\end{alexlisting}


Die Konvertierung des \enquote{Models} in das \enquote{ViewModel} erfolgt wie gewohnt über das Heraussuchen des korrekten Objektes aus der Menge der Auswahloptionen über die Abkürzung \LstZ{\ref{lst:Schritt2KonvertierungDesModelsInDasViewModel}}{29-36}.

\begin{alexlisting}{Schritt 2}{Konvertierung des \enquote{Models} in das \enquote{ViewModel} für die \enquote{Maßnahmencharakteristika}}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=19, lastline=38, highlightlines={26-37}}
  \label{lst:Schritt2KonvertierungDesModelsInDasViewModel}
\end{alexlisting}

Wenn in jeder Zeile der Ausdruck \IC{model.massnahmenCharakteristika} stehen würde, wäre die Leserlichkeit stark eingeschränkt. Das würde für weitere Zeilenumbrüche sorgen. Deshalb speichert die lokale Variable \IC{mc} den Ausdruck zwischen und kann in den folgenden Zeilen verwendet werden \Z{27}.
Damit die variable \IC{mc} jedoch nur Gültigkeit für die folgenden Zeilen hat, begrenzen die öffnenden und schließenden geschweiften Klammern den Sichtbarkeitsbereich \Z{26,37}.

Bei der Konvertierung des \enquote{Models} in das \enquote{ViewModel} wurde bereits beim letzten Schritt die Methode \IC{update} verwendet, um das Objekt des geschachtelten Wertetyps \IC{Identifikatoren} anzupassen \LstZ{\ref{lst:Schritt2KonvertierungDesViewModelsInDasModel}}{44}. So ist es auch für den geschachtelten Wertetyp \IC{MassnahmenCharakteristika} der Fall. Der Unterschied: Es handelt sich um Auswahloptionen, weshalb nur die Abkürzungen abgespeichert werden \Z{46-50}, so wie es auch schon bei \IC{letzterStatus} geschah \Z{42}.

\begin{alexlisting}{Schritt 2}{Konvertierung des \enquote{ViewModels} in das \enquote{Model} für die \enquote{Maßnahmencharakteristika}}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=40, lastline=50, highlightlines={45-50}}
  \label{lst:Schritt2KonvertierungDesViewModelsInDasModel}
\end{alexlisting}

\subsection{Aktualisierung der Eingabemaske}

Nach der Anpassung des \enquote{ViewModels} kann schließlich die Eingabemaske erweitert werden.

Im letzten Schritt nahm die Selektionskarte für den letzten Status 11 Zeilen ein \HP{R}. 
Das wäre für jede weitere Karte nun auch der Fall.
Damit die Übersichtlichkeit darunter nicht leidet, soll nun zunächst eine Methode erstellt werden, welche die Erstellung der Selektionskarten abstrahiert und damit den Aufruf auf 3 Zeilen reduziert.
Dies erlaubt auch die Konfiguration der Selektionskarten außerhalb der Klasse \IC{SelektionCard}.
In den folgenden Schritten soll diese Konfigurationsmöglichkeit genutzt werden, um weitere Funktionalitäten hinzuzufügen, ohne die Klasse selbst zu manipulieren.
Die Methode \IC{buildSelectionCard} bekommt dazu nur die Argumente für die Liste aller Auswahloptionen \IC{allChoices} \LstZ{\ref{lst:Schritt2MassnahmencharakteristikaSelektionskartenWerdenErgaenzt}}{49} und das \enquote{Subject} \IC{selectionViewModel} \Z{50} übergeben.
Nun übernimmt die Methode die Übergabe der Argumente an den Konstruktor der \IC{SelectionCard}.
Dazu verwendet die \IC{SelectionCard} wie zuvor den Namen der Menge der Auswahloptionen als Titel \Z{52}.
Außerdem wird dieselbe Menge unverändert an die SelektionCard weitergegeben \Z{53}.

\begin{alexlisting}{Schritt 2}{Die Methode \enquote{buildSelectionCard}}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=48, lastline=60, highlightlines={77-89, 82-99}}
  \label{lst:Schritt2MassnahmencharakteristikaSelektionskartenWerdenErgaenzt}
\end{alexlisting}

Der Grund, warum die Klasse \IC{SelectionCard} den Titel aus der Menge der Auswahloptionen nicht selbständig extrahiert ist, dass die Klasse auf diese Weise auch für mehrere Anwendungsgebiete genutzt werden kann.
Es muss nicht immer der Fall sein, dass der Titel auf diese Art und Weise ausgelesen werden kann.
Somit erlaubt die Methode \IC{buildSelectionCard} nun den Aufruf trotzdem zu vereinfachen und die Anwendbarkeit der Klasse \IC{SelectionCard} durch deren direkte Veränderung nicht einzuschränken.

Das betrifft auch das \enquote{ViewModel}. Durch die Methode \IC{buildSelectionCard} muss lediglich das \IC{BehaviorSubject} übergeben werden. Die Methode kümmert sich bei Initialisierung der Selektionskarte um das Auslesen des aktuellen Wertes \Z{54-56} und die Aktualisierung dessen über die Methoden \IC{onSelect} \Z{57} und \IC{onDeselect} \Z{58}. Damit ist die Erstellung der Selektionskarte für den letzten Status mit 3 Zeilen \Lst{\ref{lst:Schritt2BuildSelectionCardLetzterStatusChoices}} nun deutlich kürzer als die ursprüngliche Variante mit 11 Zeilen (siehe Seite \pageref{lst:Schritt1AusgabeDerFormularfelder}).

\begin{alexlisting}{Schritt 2}{Der Aufruf von \enquote{buildSelectionCard} für die Menge \enquote{letzterStatusChoices}}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=77, lastline=79}
  \label{lst:Schritt2BuildSelectionCardLetzterStatusChoices}
\end{alexlisting}

Unterhalb des Eingabefeldes für den Maßnahmen-Titel können nun die weiteren Selektionskarten ergänzt werden, die jeweils ebenfalls bloß 3 Zeilen einnehmen und damit eine hohe Übersichtlichkeit gewährleisten \LstZ{\ref{lst:Schritt2MassnahmencharakteristikaSelektionskartenWerdenErgaenzt}}{82-98}.

\begin{alexlisting}{Schritt 2}{Die \enquote{Maßnahmencharakteristika} Selektionskarten werden ergänzt}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=80, lastline=98, highlightlines={82-98}}
  \label{lst:Schritt2MassnahmencharakteristikaSelektionskartenWerdenErgaenzt}
\end{alexlisting}

Auffällig hierbei sind Überschriften \Z{80, 82} und eine Zwischenüberschrift \Z{89} über den Selektionskarten. Sie sorgen für sichtbare Gruppierungen in der Oberfläche.

Die Hilfsfunktionen \IC{buildSectionHeadline} und \IC{buildSubSectionHeadline} bauen die Überschriften \LstZ{\ref{lst:Schritt2buildSectionHeadlineBuildSubSectionHeadline}}{131-134} bzw. Zwischenüberschriften \Z{136-139} mit unterschiedlichen Abständen zur Außenkante \Z{132, 137} und unterschiedlichen Schriftgrößen \Z{133, 138}. Der benannte Konstruktor \IC{fromLTRB} der Klasse \IC{EdgeInsets} erlaubt, die Abstände zur Außenkante im Uhrzeigersinn für jede Seite festzulegen. Die Abkürzung \IC{LTRB} steht dabei für left, top, right, bottom -- deutsch links, oben, rechts, unten.

\begin{alexlisting}{Schritt 2}{Die Hilfsfunktionen \enquote{buildSectionHeadline} und \enquote{buildSubSectionHeadline}}
  {Quellcode/Schritt-2/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=131, lastline=140}
  \label{lst:Schritt2buildSectionHeadlineBuildSubSectionHeadline}
\end{alexlisting}

Damit ist die Implementierung für Schritt 2 beendet.

Der Integrationstest kann nun verifizieren, dass die Eingaben erfolgen und in der JSON-Datei auftauchen werden.

