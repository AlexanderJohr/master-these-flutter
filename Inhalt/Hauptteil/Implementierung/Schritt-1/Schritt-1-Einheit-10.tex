\ifodd\value{page}\hbox{}\newpage\fi
\section{Eingabeformular}
  
Das soeben erstellte \enquote{ViewModel} kann nun für die Eingabemaske verwendet werden.
Listing \ref{lst:Schritt1KlasseMassnahmenDetailScreenStruktur} zeigt die grundlegende Struktur der Klasse \IC{MassnahmenDetailScreen}.
Wiederum werden das \enquote{ViewModel} und das \enquote{Model} über das \enquote{InheritedWidget} \IC{AppState} abgerufen
und in die jeweiligen lokalen Variablen \IC{vm} und \IC{model} gespeichert \Z{16, 17}.

Nachfolgend werden zwei Funktionen innerhalb der \IC{build}-Methode deklariert:
\IC{saveRecord} \Z{19-28} und \IC{createMassnahmenTitelTextFormField} \Z{30-44}.
Solche sogenannte \enquote{nested functions} -- deutsch
verschachtelte Funktionen -- sind in \enquote{Dart} erlaubt, was zu einer weiteren Besonderheit führt.
Der Sichtbarkeitsbereich von Variablen ist in \enquote{Dart} lexikalisch.
Die Bindung der Variablen ist also durch den umgebenden Quelltext bestimmt.
Die lokalen Variablen \IC{model} und \IC{vm} sind also im gesamten Bereich sichtbar,
der durch die öffnenden und schließenden geschweiften Klammern der Methode \IC{build} aufgespannt wird \Z{15-103}.
Damit sind sie auch innerhalb der beiden verschachtelten Funktionen verfügbar.
Innerhalb der Funktionen kann auf \IC{model} und \IC{vm} zugegriffen werden, ohne sie über einen Parameter übergeben zu müssen.


Das erste \enquote{Widget} im Inhaltsbereich des \IC{Scaffold}-Elements ist ein \IC{WillPopScope} \Z{50}.
Es erlaubt das Verlassen einer Route an eine Abhängigkeit zu knüpfen.
Bei dem Eingabeformular handelt es sich um eine Unterseite.
% Meine Formulierung wäre:
Dadurch erscheint in der \IC{AppBar} \Z{47-48} links von der Überschrift ein Button, der es ermöglicht,
zur letzten Ansicht zurück zu navigieren.
Dabei stellt sich jedoch die Frage, was mit der bis zu diesem Zeitpunkt eingetragenen Maßnahme passieren soll.
Für die Formularanwendung soll in diesem Fall die Maßnahme im aktuellen Zustand abgespeichert werden.
Dazu wird dem Parameter \IC{onWillPop} als Argument die Funktion \IC{saveRecord} zugewiesen.

Anders als im Übersichtsbildschirm erhält das \IC{Scaffold} kein Argument für den Parameter \IC{floatingActionButton}.
Der Hintergrund dafür ist, dass auf diesem Bildschirm in den nächsten Schritten nicht nur ein, sondern zwei solcher Buttons zur Verfügung stehen sollen.
Daher muss der Button manuell angelegt werden.
Das ist nur mithilfe eines \IC{Stack}-\enquote{Widgets} möglich, welcher als Kind des \IC{WillPopScope} eingetragen ist.
Ein \IC{Stack} erlaubt es, mehrere Ebenen in der Tiefe anzulegen.
Das unterste Element soll die Auflistung der Eingabefelder sein.
Der \IC{SingleChildScrollView} \Z{54-79} bietet einen vertikalen Scrollbereich an, in dem die Eingabefelder in einer \IC{Column} \Z{58-76} untereinander aufgelistet sind.
Die Ebene, die  über den Eingabefeldern eingeblendet wird, soll die beiden Aktionsbuttons zeichnen.
Das \enquote{Widget} \IC{Align} erlaubt es, in dieser Ebene festzulegen, wo die Elemente angeordnet sein sollen \Z{80-99}.
Wie für den \IC{FloatingActionButton} üblich wurde die untere rechte Bildschirmecke gewählt \Z{81}.
Die Buttons sollen in Zukunft übereinander angeordnet sein, weshalb ein \IC{Column}-\enquote{Widget} zum Einsatz kommt \Z{84-97}.
Zum ersten Mal taucht der Parameter \IC{mainAxisSize} auf \Z{85}.
Mit dem Argument \IC{MainAxisSize.min} nimmt die \IC{Column} in der Höhe nur so viel Platz ein,
wie durch die Kindelemente notwendig ist.


\ifIncludeFigures
  \begin{listing}[htbp]
    \let\oldtheFancyVerbLine\theFancyVerbLine
  \renewcommand\theFancyVerbLine{%
\ifnum\value{FancyVerbLine}=20 
  \setcounter{FancyVerbLine}{27}%\scriptsize\ldots
\else\ifnum\value{FancyVerbLine}=31
  \setcounter{FancyVerbLine}{43}%\scriptsize\ldots
\else\ifnum\value{FancyVerbLine}=59
  \setcounter{FancyVerbLine}{75}%\scriptsize\ldots
\else
\oldtheFancyVerbLine%
\fi
\fi
\fi
}
    \begin{minted}[firstnumber=7]{dart}
const saveMassnahmeTooltip = "Validiere und speichere Massnahme";

class MassnahmenDetailScreen extends StatelessWidget {
  static const routeName = '/massnahmen-detail';

  const MassnahmenDetailScreen({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final vm = AppState.of(context).viewModel;
    final model = AppState.of(context).model;

    Future<bool> saveRecord() {
      /* ... */
    }

    Widget createMassnahmenTitelTextFormField() {
      /* ... */
    }

    return Scaffold(
        appBar: AppBar(
          title: const Text('Maßnahmen Detail'),
        ),
        body: WillPopScope(
          onWillPop: () => saveRecord(),
          child: Stack(
            children: [
              SingleChildScrollView(
                child: Center(
                  child: Padding(
                    padding: const EdgeInsets.all(8.0),
                    child: Column(
                      /* ... */
                    ),
                  ),
                ),
              ),
              Align(
                alignment: Alignment.bottomRight,
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      FloatingActionButton(
                        tooltip: saveMassnahmeTooltip,
                        heroTag: 'save_floating_action_button',
                        child: const Icon(Icons.check, color: Colors.white),
                        onPressed: () {
                          saveRecord();
                          Navigator.of(context).pop();
                        },
                      )
                    ],
                  ),
                ),
              )
            ],
          ),
        ));
  }
}
\end{minted}
    \alexlistingcaption{Schritt 1}{Die Struktur des Bildschirms \enquote{MassnahmenDetailScreen}} {Quellcode/Schritt-1/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
    
    \label{lst:Schritt1KlasseMassnahmenDetailScreenStruktur}
  \end{listing}
\fi

Als bisher einziges Element in der \IC{Column}  taucht nun der \IC{FloatingActionButton} auf \Z{87-95},
der die aktuell eingetragenen Daten abspeichern \Z{92} und zur Übersicht zurückkehren soll \Z{93}.
Wenn der Nutzer den Mauszeiger über diesen Button bewegt,
wird ein Tooltipp angezeigt: "Validiere und speichere Massnahme" \Z{88}.
Der Tooltipp ist als Konstante angelegt \Z{7}.
Das hat vor allem den Grund,
dass er auch für den folgenden Integrationstest genutzt wird. Elemente können darin über einen beinhaltenden Text oder Tooltipp gefunden werden.




\subsection{Ausgabe der Formularfelder}

Listing \ref{lst:Schritt1AusgabeDerFormularfelder} zeigt die Ausgabe der Formularfelder in einer \IC{Column} \Z{58}.
Das Auswahlfeld für den letzten Status verwendet ein selbst geschriebenes \IC{Widget} namens \IC{SelectionCard} \Z{61-72}.
Da die Menge der Auswahloptionen auch den Namen der Liste enthält, kann er als Titel der Selektionskarte verwendet werden \Z{62}. In diesem Fall ist das der Text \enquote{Status}.
Die Auswahloptionen, welche der Selektionsbildschirm anzeigen soll, sind dem Parameter \IC{allChoices} hinterlegt \Z{63}.

Die Selektionskarte soll ihren eigenen Zustand pflegen.
Sie erhält dazu lediglich den initialen Wert, der aktuell im \enquote{ViewModel} gespeichert ist.
Bei allen Änderungen, die innerhalb der Selektionskarte erfolgen, sollen die gleichen Änderungen auch im \enquote{ViewModel} nachgepflegt werden.
Sollte also der Wert des letzten Status im \enquote{ViewModel} verfügbar sein \Z{65}, so wird er als Startwert dem Parameter \IC{initialValue} \Z{64-67} übergeben.
Dabei ist zu beachten, dass das Argument eine Menge ist.
Sie wird mit den  öffnenden und schließenden geschweiften Klammern erstellt.
Das \enquote{collection if} wird hier verwendet, um genau ein Element diesem \enquote{Set}-Literal hinzuzufügen, sollte es nicht \IC{null} sein.
Ist das Element allerdings \IC{null}, so bleibt das \enquote{Set}-Literal einfach leer.
Für mehr Informationen zum \enquote{Set}-Literal und dem \enquote{collection if} siehe \HP{Kapitel einfügen}.


Wenn der Benutzer eine Auswahloption selektiert, so  wird die dementsprechende anonyme Funktion aufgerufen.
Sie ist für den Parameter \IC{onSelect} hinterlegt \Z{68-69}.
Das Gleiche gilt für Auswahloptionen, welche deselektiert werden \Z{70-71}.
Das Auswahlfeld erlaubt nur einen Wert.
Deshalb reicht es aus, den Wert bei Selektion zu ersetzen und ihn bei Deselektion zu leeren, also ihn auf \IC{null} zu setzen.

\clearpage

\begin{alexlisting}{Schritt 1}{Die Ausgabe der Formularfelder}
  {Quellcode/Schritt-1/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=58, lastline=76}
  \label{lst:Schritt1AusgabeDerFormularfelder}
\end{alexlisting}

\subsection{Eingabefeld für den Maßnahmentitel}


Unterhalb der ersten Selektionskarte soll das Eingabefeld für den Maßnahmentitel erscheinen \Z{73}.
Listing \ref{lst:Schritt1DieFunktionCreateMassnahmenTitelTextFormField} zeigt die Implementierung der verschachtelten Funktion zum Zeichnen dieses Eingabefeldes.
 Es handelt sich um das \enquote{Widget} \IC{TextFormField} \Z{34-41}.


\begin{alexlisting}{Schritt 1}{Die Funktion \enquote{createMassnahmenTitelTextFormField} in Schritt 1}
  {Quellcode/Schritt-1/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=30, lastline=44}
  \label{lst:Schritt1DieFunktionCreateMassnahmenTitelTextFormField}
\end{alexlisting}

Hier wird klar, wovon die Selektionskarte inspiriert ist.
Denn auch das \IC{TextFormField} erhält einen initialen Wert über den Parameter \IC{initialValue}.
Sobald sich der Wert des Formularfelds ändert, kann der neue Wert im \enquote{ViewModel} über die anonyme Funktion aktualisiert werden, welche dem Parameter \IC{onChanged} übergeben wurde.
