
\ifodd\value{page}\hbox{}\newpage\fi
\section{ Abhängigkeit zum Verwalten der Maßnahmen}

Die Art und Weise, wie die Maßnahmen abgerufen werden, sollte nach Möglichkeit abstrahiert werden.
Das erlaubt, den Mechanismus in Zukunft auszutauschen, ohne dabei den Rest der Applikation verändern zu müssen.
So wäre es beispielsweise denkbar, statt zu einer \enquote{JSON}-Datei eine direkte Verbindung zu einer relationalen Datenbank herzustellen.
Auch das Austauschen der Abhängigkeit mit einem Platzhalter, der lediglich die Aufrufe der Methoden zählt, ist damit möglich.
Ein solches Platzhalterobjekt wird \enquote{Mock} genannt und für automatisiertes Testen eingesetzt (siehe Kapitel \ref{sec:Integrations} \enquote{\nameref{sec:Integrations}} auf Seite \pageref{sec:Integrations}).
Ebenso abstrahiert werden soll der Umgang mit Ausnahmen.
Sollte die Datei nicht verfügbar sein, so muss die Oberfläche davon nicht zwingend betroffen sein.
Stattdessen kann der Service sich entscheiden, eine leere Liste von Maßnahmen zurückzugeben.
Sobald die Liste manipuliert wird, kann eine neue Datei angelegt werden und sie mit den eingegebenen Daten beschrieben werden.
Die Klasse \IC{MassnahmenModel} \Lst{\ref{lst:Schritt1KlasseMassnahmenModel}} tut genau das.


%\footcite[Vgl.][S. 288]{gamma2009entwurfsmuster}
%\footcite[Vgl.][S. 1]{ElliottHudak97:Fran}
%\footcite[Vgl.][S. 1]{ElliottHudak97:Fran}

Sie bekommt \IC{MassnahmenJsonFile} im Konstruktor übergeben \Z{11}.
Daraufhin ruft der Konstruktor gleich die \IC{init}-Methode auf \Z{12}, welche in den Zeilen 15 bis 22 deklariert ist.
Darin wird der \enquote{Stream} \IC{storage} \Z{19} initialisiert.
Es handelt sich um eine Erweiterung eines \enquote{broadcast streams} mit dem Namen \IC{BehaviorSubject} \Z{9}.
Es entstammt dem Paket \enquote{RxDart},
welches die \enquote{Streams} in \enquote{Dart} um eine Reihe von weiteren Funktionalitäten erweitert.
Der Begriff \enquote{Behaviour} stammt aus der funktionalen reaktiven Programmierung:
\say{Behaviors are time-varying, reactive values}\footcite[][S. 1]{ElliottHudak97:Fran}
Das \enquote{Subject}
-- deutsch \enquote{Subjekt} --
gehört wiederum neben dem \enquote{Beobachter} zu den Akteuren des \enquote{Beobachter}-Entwurfsmusters
und ist dafür zuständig, die \enquote{Beobachter} über Änderungen zu benachrichtigen.
\footcite[Vgl.][S. 288]{gamma2009entwurfsmuster}
Ein \IC{BehaviorSubject} hat im Gegensatz zu gewöhnlichen \enquote{Streams} die Besonderheit,
dass es den Wert des letzten Ereignisses zwischenspeichert.
Die \enquote{broadcast streams} haben für gewöhnlich den Nachteil,
dass neue Zuhörer des \enquote{Streams} nur die neuen Ereignisse erhalten.
Alle in der Vergangenheit erfolgten Ereignisse sind nicht mehr verfügbar.
Vor allem dann,
wenn in der Oberfläche der letzte Wert eines \enquote{Streams} verwendet werden soll,
um Elemente zu zeichnen,
ist das von einem besonderen Nachteil.
Denn wenn der \enquote{Stream} zuvor initialisiert wurde,
so gibt es keine Daten zu dem Zeitpunkt,
wenn die Oberfläche gezeichnet wird.
Sollte die Oberfläche gezeichnet werden,
bevor der \enquote{Stream} initialisiert wurde,
so  existieren ebenfalls keine Daten.
Hier kommt das \IC{BehaviorSubject} ins Spiel.
Sobald die Oberfläche gezeichnet wird und der \enquote{Stream} bereits initialisiert ist,
kann dennoch auf den zuletzt übertragenen Wert zurückgegriffen werden.
Anschließend überträgt der \enquote{Stream} die folgenden Aktualisierungen für die Oberfläche mit jedem neuen Ereignis,
so wie es für \enquote{Streams} üblich ist.

Der \enquote{Stream} kann nicht bereits in der Initialisierungsliste des Konstruktors mit den Daten aus der \enquote{JSON}-Datei gefüllt werden.
Das liegt daran, dass die \enquote{JSON}-Daten dazu zunächst gelesen werden müssen, was nur durch eine Reihe von asynchronen Operationen möglich ist.
In einer Initialisierungsliste können allerdings keine asynchronen Operationen ausgeführt werden.
Deshalb wird \IC{init} erst im Konstruktor-Körper aufgerufen \Z{12}.
Damit der \enquote{Stream} anfangs nicht leer ist, füllt ihn der benannte Konstruktor \IC{seeded} mit einem leeren Objekt des Typs \IC{Storage} \Z{9}.
Sobald die Datei gelesen \Z{17} und deserialisiert wurde \Z{20}, erhält der \enquote{Stream} über die \enquote{Setter}-Methode \IC{value} ein neues Ereignis mit dem gelesenen Wert \Z{19}.
Die Initialisierung ist von einem \IC{try}-Block umgeben.
Sollte die Initialisierung fehlschlagen, weil die \enquote{JSON}-Datei nicht existiert, wird die entsprechende Fehlerbehandlung ausgeführt \Z{21}.
Diese ist leer, da sich im \enquote{Stream} bereits ein leeres \IC{Storage}-Objekt  befindet.
Mit diesem leeren Objekt kann die Oberfläche weiterarbeiten.
In Zukunft könnte es sinnvoll sein, innerhalb der Fehlerbehandlung eine Meldung an den Benutzer zu geben, um darüber zu informieren, dass eine neue Datei angelegt wurde.

Mit \IC{putMassnahmeIfAbsent} \Z{24-33} steht eine Methode bereit, um gleichzeitig sowohl die Oberfläche als auch die \enquote{JSON}-Datei zu aktualisieren.
Sollte die eingetragene Maßnahme schon existieren, wird sie zunächst gelöscht \Z{26}.
In jedem Fall wird die neue Maßnahme der Menge \IC{massnahmen} hinzugefügt \Z{27}.
Durch Austauschen des gesamten Objektes mit der Zuweisung zu \IC{storage.value} \Z{25} erhält der \enquote{Stream} erneut ein neues Ereignis, womit er die Oberfläche benachrichtigen kann,
sich neu zu zeichnen.
Außerdem wird die Serialisierung des \IC{Storage}-Objektes angestoßen \Z{29-30}.
Die neue Liste von Maßnahmen wird im darauffolgenden Schritt zurück in die \enquote{JSON}-Datei gespeichert \Z{32}.

\begin{alexlisting}{Schritt 1}{Die Klasse MassnahmenModel}
  {Quellcode/Schritt-1/conditional_form/lib/data_access/massnahmen_model.dart}
  {firstline=7}
  \label{lst:Schritt1KlasseMassnahmenModel}
\end{alexlisting}
