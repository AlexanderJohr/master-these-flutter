\chapter{Schritt 4}
\label{chap:Schritt-4}


\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-4/D Z Wald.png}
  {Schritt 4 Eingabemaske}
  {XXX Die Eingabemaske zeigt im Schritt 1 eine Karte zum Selektieren des Status und ein Eingabefeld für den Titel}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-4/D Z Wald Rot.png}
  {Schritt 4 Eingabemaske}
  {XXX Die Eingabemaske zeigt im Schritt 1 eine Karte zum Selektieren des Status und ein Eingabefeld für den Titel}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}


\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-4/D D Z Wald Rot.png}
  {Schritt 4 Eingabemaske}
  {XXX Die Eingabemaske zeigt im Schritt 1 eine Karte zum Selektieren des Status und ein Eingabefeld für den Titel}

  \label{fig:Schritt4Eingabemaske}

\end{alexfigure}


Im Folgenden werden der Validierung die Bedingungen hinzugefügt,
welche die Auswahloptionen untereinander haben. 

\section{Hinzufügen der Bedingungen zu den Auswahloptionen}

Es gibt einfache Bedingungen wie beispielsweise die der Zielfläche \enquote{AL}.
Dessen Auswahl kann nur dann erfolgen,
wenn nicht die Kategorie \enquote{Anbau Zwischenfrucht/Untersaat} ausgewählt ist \Lst{\ref{lst:Schritt4al}}.

\begin{alexlisting}{Schritt 4}{XXXXX}
  {Quellcode/Schritt-4/conditional_form/lib/choices/choices.dart}
  {firstline=79, lastline=80, highlightlines={80}}
  \label{lst:Schritt4al}
\end{alexlisting}

Doch es tauchen auch komplexe Bedingungen auf,
wie etwa die Abhängigkeit der Zielfläche \enquote{Wald/Forst} \Lst{\ref{lst:Schritt4wald}}.
Um sie auszuwählen,
muss die Förderklasse eine von 3 Werten beinhalten:
\enquote{Erschwernisausgleich} \Z{97},
\enquote{Agrarumwelt-(und Klima)Maßnahme: nur Vertragsnaturschutz} \Z{98} oder
\enquote{Agrarumwelt-(und Klima)Maßnahmen, tw. auch mit Tierwohlaspekten , aber OHNE Vertragsnaturschutz} \Z{99}.

Gleichzeitig darf für die \enquote{Kategorie} weder
\enquote{Anbau Zwischenfrucht/Untersaat} \Z{100}
noch
\enquote{Förderung bestimmter Rassen / Sorten / Kulturen} \Z{101}
gewählt sein.

Äußerst wichtig ist hier die Auswahl der richtigen logischen Operatoren.
Innerhalb des gleichen Typs -- wie etwa der \enquote{Förderklasse} -- muss das logische Oder \IC{||} verwendet werden \Z{97, 98, 100}.
Das logische Und würde hier keinen Sinn ergeben,
da es unmöglich ist,
in einem Einfachauswahlfeld gleichzeitig zwei Optionen ausgewählt zu haben.
Um Bedingungen unterschiedlichen Typs miteinander zu verknüpfen,
ist dagegen das logische und \IC{&&} zu benutzen \Z{99},
denn die Bedingungen der \enquote{Förderklasse} und der \enquote{Kategorie} müssen gleichzeitig erfüllt sein.
Hier ist wiederum das Nutzen des logischen Oders nicht angemessen, denn es wäre nicht ausreichend,
wenn nur die Bedingungen eines der beiden Typen erfüllt wäre.
Wäre also beispielsweise für die \enquote{Förderklasse} die Option \enquote{Erschwernisausgleich} gewählt,
so wäre es völlig unerheblich,
welche Auswahl für die \enquote{Kategorie} selektiert wurde.
Die Bedingung wäre trotzdem erfüllt,
auch wenn für die \enquote{Kategorie} die nicht erlaubte Option \enquote{Anbau Zwischenfrucht/Untersaat} gewählt ist.

\begin{alexlisting}{Schritt 4}{XXXXX}
  {Quellcode/Schritt-4/conditional_form/lib/choices/choices.dart}
  {firstline=95, lastline=101, highlightlines={96-101}}
  \label{lst:Schritt4wald}
\end{alexlisting}

Für die Liste aller hinzugefügten Bedingungen siehe Anhang \ref{appendix:Schritt4Anhang} auf den Seiten \pageref{lst:Schritt4KategorieChoice} bis  \pageref{lst:Schritt4ZieleinheitChoice}.

Bei der Bedingungen handelt sich um eine Funktion,
die einen Wahrheitswert \IC{bool} zurückgibt und als Parameter die Menge aller bisher ausgewählten Auswahloptionen \IC{Set<Choice>} übergeben bekommt.
Die Signatur dieser Funktion wird als Typdefinition mit dem Namen \IC{Condition} deklariert \LstZ{\ref{lst:Schritt4Choice}}{3}.
Über diese Typdefinition kann sie als Instanzvariable in der Klasse \IC{Choice} deklariert werden \Z{8}.
Der Konstruktor erhält einen weiteren Parameter für die Bedingung \Z{12}.

Er ist optional,  da es Auswahloption gibt, die keine Bedingung haben. 
Deshalb wird mit der Notation \IC{Condition?} erreicht,
dass die Bedingung auch ausgelassen werden kann und in diesem Fall \IC{null} ist.
Sollte das der Fall sein,
so soll eine Standardfunktion verwendet werden.
Diese Standardfunktion ist \IC{_conditionIsAlwaysMet} \Z{15}.
Unerheblich davon welche Auswahloptionen in Vergangenheit gewählt wurden,
gibt diese Funktion immer \IC{true} zurück.
Denn eine Auswahloption,
die keine Bedingung hat,
ist immer auswählbar. 
Sollte die übergebene Bedingungen ausgelassen worden und damit \IC{null} sein,
so wählt die \enquote{If-null Expression} den Ausdruck rechts von dem \IC{??} und damit die Standardfunktion \IC{_conditionIsAlwaysMet} aus,
welche der Instanzvariablen \IC{condition} zugewiesen wird \Z{13}.
Ansonsten speichert der Konstruktor die übergebene Funktion. 
Aus diesem Grund ist es nicht möglich,
dass die condition in der Instanzvariablen nur sein kann,
weshalb sie ohne den Suffix? Als variable ohne zu null Zulässigkeit deklariert werden kann. 
Da der Ausdruck rechts von dem \IC{??} nicht \IC{null} sein kann,
so kann auch der gesamte Ausdruck der vorliegenden \enquote{If-null Expression} nicht \IC{null} sein.
Damit ist es möglich,
die Instanzvariable \IC{condition} ohne den Suffix \IC{?} als Variable ohne Null-Zulässigkeit zu deklarieren. 
Die Instanzmethode \IC{conditionMatches} ruft die übergebender Funktion für die Bedingung über die Methode \IC{call} auf \Z{10}.
Das erlaubt den Ausdruck  durch vereinfacht darzustellen. 
Der Ausdruck \IC{wald.condition(priorChoices)} kann dadurch durch die explizitere Schreibweise \IC{wald.conditionMatches(priorChoices)} ersetzt werden. 

\begin{alexlisting}{Schritt 4}{XXXXX}
  {Quellcode/Schritt-4/conditional_form/lib/choices/base/choice.dart}
  {firstline=3, lastline=16, highlightlines={3,8,10, 12-13, 15 }}
  \label{lst:Schritt4Choice}
\end{alexlisting}

\section{Hinzufügen der Momentaufnahme aller ausgewählten Optionen im gesamten Formular}

Die Menge der bisherigen Ausfülloptionen setzt sich aus den aktuellen Inhalten der Auswahlfelder zusammen.
Sie ist also die Momentaufnahme aller Werte,
die jeweils über die Getter-Methode \IC{value} von allen \IC{BehaviorSubject}-Objekten im ViewModel abgerufen werden kann.
Doch genau diese Momentaufnahme muss immer dann neu erstellt werden,
wenn sich auch nur ein Auswahlfeld ändert.
Genau darum kümmert sich das \IC{BehaviorSubject} \IC{priorChoices} im ViewModel \Lst{\ref{lst:Schritt4priorChoices}}.

\begin{alexlisting}{Schritt 4}{XXXX}
  {Quellcode/Schritt-4/conditional_form/lib/screens/massnahmen_detail/massnahmen_form_view_model.dart}
  {firstline=20, lastline=41}
  \label{lst:Schritt4priorChoices}
\end{alexlisting}

Es wird mit dem Typparameter \IC{Set<Choice>} deklariert \Z{20} und mit einer Momentaufnahme initialisiert: einer leeren Menge) \Z{21}.
Im Konstruktor des ViewModels wird dann auf Änderung aller \IC{BehaviorSubject}-Objekte im ViewModel gehorcht.
Dies wird durch die Funktion \IC{combineLatest} des Pakets \IC{rx.dart} ermöglicht \IC{24}.
Sie erlaubt die Übergabe einer Kollektion von Streams.
In diesem Fall alle \IC{BehaviorSubject}-Objekte des ViewModels \Z{25-29}.
Wenn auch nur einer dieser Streams ein neues Ereignis sendet,
so emittiert auch der kombinierte Stream ein neues Ereignis.
Dem zweiten Parameter der Funktion \IC{combinelatest} kann als Argument eine Funktion übergeben werden,
die das zu emittierende Ereignis konstruiert \Z{30-37}.
Der erste Parameter dieser Funktion enthält alle letzten Ereignisse der übergebenen Streams.
Doch der vorliegende Aufruf hat keine Verwendung für den Parameter.
Statt eines Variablennamens wird hier ein Unterstrich \IC{_} verwendet \Z{30}.

In Sprachen wie etwa \enquote{JavaScript} und \enquote{Python} ist dies gängige Praxis für die Benennung von Parametern,
die nicht genutzt werden.
In Kotlin und Dart wurde diese Praxis zur Konvention gemacht
\footcite[Vgl.][]{DartEffectiveDartStylePREFERusingUnderscore}
\footcite[Vgl.][]{KotlinHighOrderFunctionsAndLambdasUnderscoreForUnusedVariables}
. 
Die anonyme Funktion gibt eine Menge zurück,
in welcher alle Werte der \IC{BehaviorSubject}-Objekte integriert werden \Z{31-37}.
Das \enquote{Collection if} Statement schließt dabei jeweils den Wert \IC{null} aus \Z{32-36}.
Somit taucht niemals der Wert \IC{null} in der Menge auf und damit kann die Menge mit dem Typparameter \IC{Choice} ohne Null-Zulässigkeit deklariert werden.
Sollte ein Auswahlfeld nicht gewählt und damit der Wert des \IC{BehaviorSubject} \IC{null} sein, so taucht diese Option einfach nicht in der Menge auf.
Sind alle Auswahlfelder nicht belegt und damit \IC{null}, so ist die Menge leer.
Doch der kombinierte Stream \IC{choicesStream} liefert immer nur die neuen Ereignisse und speichert nicht den zuletzt übermittelten Wert.
Deshalb wird das \IC{BehaviorSubject} \IC{priorChoices} verwendet.
Die Methode \IC{listen} horcht auf Änderungen des \IC{choicesStream}-Objekts und fügt das übertragene Ereignis immer \IC{priorChoices} hinzu. 
Damit existiert immer ein Wert für die Momentaufnahme der aktuell ausgewählten Auswahloptionen.
Sie ist ursprünglich die leere Menge \IC{{}} und nachfolgend immer das zuletzt übermittelte Ereignis des \IC{choicesStream}.

\section{Reagieren der Selektionskarte auf die ausgewählten Optionen}

Dadurch
, dass \IC{priorChoices} nun im ViewModel verfügbar ist
, kann es im Eingabeformular bei der Konstruktion der \IC{SelectionCard} als Argument übergeben werden \LstZ{\ref{lst:Schritt4builderSelectionCard}}{143}.

\begin{alexlisting}{Schritt 4}{Die Ausgabe der Formularfelder}
  {Quellcode/Schritt-4/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=140, lastline=143, highlightlines={143}}
  \label{lst:Schritt4builderSelectionCard}
\end{alexlisting}

Die Klasse \IC{SelectionCard} deklariert die \IC{priorChoices} als Instanzvariable \LstZ{\ref{lst:Schritt4SelectionCardPriorChoices}}{19} und initialisiert sie direkt bei der Übergabe im Konstruktor, ohne sie zu modifizieren \Z{28}.

\begin{alexlisting}{Schritt 4}{XXXX}
  {Quellcode/Schritt-4/conditional_form/lib/widgets/selection_card.dart}
  {firstline=15, lastline=32, highlightlines={19,28}}
  \label{lst:Schritt4SelectionCardPriorChoices}
\end{alexlisting} 


Dadurch, dass das \IC{BehaviorSubject} ein Stream ist,
kann die Selektionskarte auf Änderungen reagieren,
die sich an \IC{priorChoices} vollziehen,
obwohl diese Änderungen außerhalb der Klasse geschehen.
Würde stattdessen eine Liste der bisherigen Auswahloption übergeben werden,
so wäre diese eine Kopie.
Diese Kopie hätte den Zustand einer Momentaufnahme aller bisherigen Auswahloptionen zum Zeitpunkt der Konstruktion des \IC{SelectionCard}-Elementes.
Alle Änderungen,
die nach diesem Zeitpunkt an den Auswahloptionen geschehen sind,
würden sich nicht darin widerspiegeln.
Eine Selektionskarte würde daher auch keinen Fehler anzeigen,
wenn ihre ausgewählten Optionen durch Änderungen von außen invalide werden würden.
Der Grund dafür ist,
dass sie noch eine alte Kopie der bisherigen Auswahloptionen verwendet.

Eine andere Möglichkeit wäre,
eine Setter-Methode zu implementieren,
die den Wert der bisherigen Auswahloptionen neu setzt.
Doch das Programm verwaltet keine Referenzen auf alle gebauten Selektionskarten.
Somit kann auch nicht über eine Referenz eine Setter-Methode aufgerufen werden,
denn eine solche Referenz existiert nicht. 
Die übliche Vorgehensweise wäre in Flutter, das gesamte Widget neu zu zeichnen.
Bei Einsatz eines \enquote{StatefulWidgets} und Zustandsänderungen über die \IC{setState}-Methode würde dies das Neuzeichnen des gesamten Formulars bedeuten.

Performante ist es dagegen,
wenn nur die Inhalte der Selektionskarten ausgetauscht werden.
Anstatt ausschließlich auf die Änderungen der eigenen Auswahloptionen zu reagieren,
horcht der StreamBuilder nun auf den Stream \IC{priorChoices} \LstZ{\ref{lst:Schritt4StreamBuilderpriorChoices}}{52}
und damit auf die Änderungen aller Auswahlfelder.
Vor der Konstruktion der Karte wird nun überprüft,
ob einer der ausgewählten Auswahloptionen in \IC{selectedChoices} eine invalide Auswahl enthält \Z{55-56}.
Das kann über die Funktion any herausgefunden werden,
indem  für jede ausgewählte Option die Methode \IC{conditionMatches} mit der Menge aller ausgewählten Optionen im gesamten Formular aufgerufen wird \Z{56}. 
Die rote Farbe der Selektionskarte wurde bereits bei der Validierung im letzten Schritt verwendet,
wenn der dem Konstruktor ein \IC{errorText} übergeben wurde.
Nun wird diese Bedingung erweitert.
Sollte es auch nur eine falsche Selektion geben
oder aber der \IC{errorText} gesetzt sein,
so ist die Karte rot.
Anderenfalls wird dem Parameter \IC{tileColor} \IC{null} übergeben \Z{70}.
\IC{null} bedeutet, dass keine Farbe übergeben und damit die Standardfarbe verwendet wird.

\begin{alexlisting}{Schritt 4}{XXXX}
  {Quellcode/Schritt-4/conditional_form/lib/widgets/selection_card.dart}
  {firstline=51, lastline=70, highlightlines={52, 55-57,69-70}}
  \label{lst:Schritt4StreamBuilderpriorChoices}
\end{alexlisting} 



\ifIncludeFigures \clearpage \fi

\section{Reagieren des Auswahlbildschirms auf die ausgewählten Optionen}



Der Auswahlbildschirm wird im Folgenden um zwei weitere Funktionalitäten erweitert \Lst{\ref{lst:Schritt4selectedAndSelectableChoices}}.
Sollten durch neue Selektionen im Formular bereits selektierte Optionen im Auswahlbildschirm nun invalide sein,
so werden diese rot gefärbt.
Weiterhin erscheinen invalide Optionen,
die nicht ausgewählt sind,
am Ende der Liste ohne Checkbox zum Auswählen.
Außerdem erhält die Option ein Kreuz-Icon als Indikator dafür, dass sie nicht angewählt werden kann.

Zu diesem Zweck konstruiert der StreamBuilder vor der Rückgabe des ListViews zwei Mengen.
Die Menge \IC{selectedAndSelectableChoices} \Z{95} beinhaltet alle Auswahloptionen,
die entweder selektiert oder selektierbar sind.
Dies beinhaltet auch Optionen, die invalide und trotzdem selektiert sind.
Die zweite Menge \IC{unselectableChoices} \Z{96} dagegen beinhaltet alle Optionen,
die invalide sind, und nicht selektiert sind.

Eine Schleife iteriert über alle verfügbaren Optionen, welche der Auswahl Bildschirm anzeigt  \Z{90-105}.
Sollte die Option in den selektierten Optionen enthalten \Z{99},
oder aber mit den Selektionen aller anderen Auswahlfelder kompatibel sein,
so wird sie der Menge \IC{selectedAndSelectableChoices} hinzugefügt \Z{101}.
In jedem anderen Fall wird die Option Teil der Menge \IC{unselectableChoices} \Z{103}.

Für die Konstruktion der \IC{CheckboxListTile}-Elemente wurde zuvor die Menge aller Auswahloptionen verwendet.
Nun wird stattdessen nur die Menge der selektierbaren und selektierten Auswahloptionen genutzt \Z{108}.
Neben dem Vergleich,
ob die Option selektiert ist \Z{109},
erfolgt nur noch ein weiterer Vergleich,
ob die Option inkompatibel mit den ausgewählten Optionen aller anderen Auswahlfelder ist \Z{111}.
Das Ergebnis des Vergleiches wird in der lokalen Variable \IC{selectedButDoesNotMatch} gespeichert.

Sollte diese Variable \IC{true} sein,
so erscheint das \IC{CheckboxListTile}-Element mit einem rot eingefärbten im Hintergrund.
Der Benutzer hat über die Checkbox dann die Möglichkeit,
diese Auswahl zu deselektieren.
Da das hinterlegte ViewModel durch diese Deselektion direkt aktualisiert wird \Z{122-123},
so baut der \IC{StreamBuilder} auch den \IC{ListView} neu.
Die deselektierte Option wird dann Teil von der Menge \IC{unselectableChoices} \Z{103} sein.
So erscheint sie dann
-- ganz genau wie alle anderen unselektierbaren Auswahloptionen --
ohne roten Hintergrund aber auch ohne anklickbare Checkbox am Ende der Liste \Z{134-142}.

Solche unselektierbaren Optionen werden schlicht als \IC{ListTile}-Element statt als \IC{CheckCoxListTile} gezeichnet \Z{135-139}.
Damit fehlt ihnen die Checkbox zum Selektieren.
Über den Parameter \IC{leading} kann jedoch anstelle der Checkbox ein beliebiges Widget
-- in diesem Fall ein Icon --
eingefügt werden.
\IC{Icons.close} zeichnet ein Kreuz-Symbol,
um zu signalisieren,
dass diese Option nicht anwählbar ist. 


\begin{alexlisting}{Schritt 4}{XXXX}
  {Quellcode/Schritt-4/conditional_form/lib/widgets/selection_card.dart}
  {firstline=88, lastline=141, highlightlines={95-105, 108, 110-111, 118, 134-141}}
  \label{lst:Schritt4selectedAndSelectableChoices}
\end{alexlisting}

\ifIncludeFigures \clearpage \fi

\subsection{Hinzufügen der Momentaufnahme zur Validierung}

Alle bisher eingefügten Vergleiche hatten lediglich den Zweck,
die invaliden Optionen einzufärben und von der Selektion durch den Benutzer auszuschließen.
Doch noch sind sie nicht Teil der Validierung des Formulars.
Sollte der Benutzer die aktuell eingetragene Maßnahmen im abgeschlossenen Status abspeichern wollen,
so kann dies auch mit invaliden Optionen erfolgen.
Um das zu verhindern,
wird noch ein Vergleich zu der anonymen Funktion hinzugefügt,
welche als Argument dem Parameter \IC{validator} des \IC{FormField} übergeben wird \Lst{\ref{lst:Schritt4validator}}.
Sollte auch nur eine der selektierten Optionen \IC{choices} die ihr hinterlegte Bedingungen nicht erfüllen \Z{132},
so speichert die lokale Variable \IC{atLeastOneValueInvalid} den Wert \IC{true} ab \Z{131}.

In dem Fall gibt die Funktion die entsprechende Fehlermeldung an den Benutzer zurück \Z{135}.
Somit ist es nun auch nicht mehr möglich,
eine Maßnahme abzuspeichern,
wenn sie invalide Auswahloptionen enthält.
Erst wenn alle Auswahlfelder gefüllt sind
und die gefüllten Optionen alle die jeweils hinterlegten Bedingungen erfüllen,
so werden die \IC{validator}-Funktionen \IC{null} statt einer Fehlermeldung zurückgeben \Z{138}.
Nur dann kann eine Maßnahme mit dem Status \enquote{abgeschlossen} gespeichert werden.


\begin{alexlisting}{Schritt 4}{Die Ausgabe der Formularfelder}
  {Quellcode/Schritt-4/conditional_form/lib/screens/massnahmen_detail/massnahmen_detail.dart}
  {firstline=121, lastline=140, highlightlines={131-136}}
  \label{lst:Schritt4validator}
\end{alexlisting}
