\chapter{Schritt 5}
\label{chap:Schritt-5}

Im letzten Schritt wurde das primäre Problem der Formularanwendung gelöst:
Auswahloptionen sollen nur dann anwählbar sein,
wenn sie die ihr hinterlegte Bedingung erfüllen.
Darüber hinaus können nur Maßnahmen gespeichert werden,
deren Auswahloptionen untereinander kompatibel sind.

Durch das Lösen dieses Problems ist ein neues Problem entstanden:
Alle Selektionskarten müssen bei einer Selektion neu gezeichnet werden.
Bei einer geringen Anzahl von Auswahlfeldern sollte das noch keine gravierenden Auswirkungen auf das Laufzeitverhalten der Applikation haben.
Doch je zahlreicher die Auswahlfelder werden,
desto länger dauert die Aktualisierung der Oberfläche.

Das Problem kann folgendermaßen entschärft werden:
Noch bevor das \enquote{Widget} \IC{SelectionCard} den \IC{StreamBuilder} in der \IC{build}-Methode zurückgibt,
wird ein neuer \enquote{Stream} namens \IC{validityChanged} erstellt \LstZ{\ref{lst:Schritt5needsRepaint}}{51-54}.

Es handelt sich um eine sogenannte Transformation des \enquote{Streams} \IC{priorChoices}, welcher die Momentaufnahme aller ausgewählten Optionen im gesamten Formular übermittelt.
Immer dann, wenn der \enquote{Stream} \IC{priorChoices} ein neues Ereignis sendet,
geschieht für die Abwandlung dieses \enquote{Streams} Folgendes:
Die Methode \IC{map} wandelt jedes Ereignis in ein neues Objekt um \Z{52}.
Die aktuelle Momentaufnahme der Auswahloptionen im Formular wird dazu im Parameter \IC{choices} gespeichert.
Bei der Umwandlung des Ereignisses werden die ausgewählten Optionen der aktuellen Selektionskarte über \IC{selectionViewModel.value} abgerufen.
Sollte es sich beispielsweise bei der aktuellen Selektionskarte um das Auswahlfeld der \enquote{Kategorie} handeln,
so könnte der ausgewählte Wert \enquote{Düngemanagement} sein.
Für den Wert oder die Werte wird nun überprüft, ob sie mit der neuen Momentaufnahme der Selektionen im Formular kompatibel sind.
Wurde also beispielsweise bei der neuen Selektion in der \enquote{Förderklasse} nun \enquote{Ökolandbau} ausgewählt,
so würde die Option \enquote{Düngemanagement} nun invalide werden,
da sie nur mit der Förderklasse \enquote{Agrarumwelt-(und Klima)Maßnahme: nur Vertragsnaturschutz} bzw. \enquote{Agrarumwelt-(und Klima)Maßnahmen, tw. auch mit Tierwohlaspekten, aber OHNE Vertragsnaturschutz} kompatibel ist.
Die Methode \IC{map} wandelt also das neue Ereignis der Momentaufnahme aller Selektionen im Formular in einen einzigen Wahrheitswert um.
Ist der Wahrheitswert \IC{true},
bedeutet dies,
dass alle ausgewählten Optionen in der aktuellen Selektionskate valide sind.
Ist er dagegen \IC{false}, so ist wenigstens eine der Auswahloptionen mit den restlichen Auswahloptionen der anderen Auswahlfelder im Formular nicht kompatibel.

Der resultierende \enquote{Stream} wird weiter transformiert: Durch die Funktion \IC{distinct} \Z{54} werden nur Ereignisse gesendet,
sofern sie sich von dem letzten Ereignis unterscheiden.
Ein Beispiel: Für die \enquote{Kategorie} ist \enquote{Düngemanagement} ausgewählt.
Für die \enquote{Förderklasse} ist \enquote{Erschwernisausgleich} im letzten Ereignis ausgewählt worden.
\enquote{Düngemanagement} ist mit \enquote{Erschwernisausgleich} nicht kompatibel, weshalb das letzte Ereignis des durch \IC{map} transformierten \enquote{Streams} \IC{false} war.
Nun wird für die \enquote{Förderklasse} eine weitere Selektion vorgenommen: \enquote{Ökolandbau} wird ausgewählt.
Auch diese Option ist mit \enquote{Düngemanagement} nicht kompatibel.
Der durch \IC{map} transformierte \enquote{Stream} wird also erneut ein Ereignis mit dem Wert \IC{false} senden.
Doch bereits das letzte Ereignis war \IC{false}.
Die Methode \IC{distinct} verhindert,
dass dieses redundante Ereignis weitergeleitet wird.
Nun erfolgt noch eine weitere Selektion: Für die \enquote{Förderklasse} wird \enquote{Agrarumwelt-(und Klima)Maßnahme: nur Vertragsnaturschutz} selektiert.
Nun ist die \enquote{Kategorie} \enquote{Düngemanagement} mit der neuen Selektion kompatibel.
Der aus der Methode \IC{map} resultierende \enquote{Stream} liefert dieses Mal den Wert \IC{true}.
Das letzte Ereignis hatte den Wert \IC{false}.
Die Werte der beiden letzten Ereignisse unterscheiden sich also,
was dazu führt,
dass die Methode \IC{distinct} das veränderte Ereignis nicht filtert, sondern weiterleitet.

Der \enquote{Stream} \IC{validityChanged} sendet also immer genau dann Ereignisse,
wenn sich etwas an der Validität der Auswahloptionen der aktuellen Selektionskarte ändert.
Doch dieser \enquote{Stream} kann nicht für den \IC{StreamBuilder} benutzt werden.
Denn wenn sich die Auswahl in der aktuellen Selektionskarte ändert
und die Validität dadurch unverändert bleibt,
so erfolgt kein neues Zeichnen der Selektionskarte.
Deshalb ist eine Kombination der \enquote{Streams} \IC{validityChanged} und \IC{selectionViewModel} erforderlich.
Das \IC{BehaviorSubject} \IC{needsRepaint} soll als diese Kombination fungieren \Z{56}.
Es wird mit dem Wert \Z{true} initialisiert.
Es ist unerheblich, welcher Wert in dem \enquote{Stream} aktuell gespeichert ist.
Lediglich dass ein neues Ereignis hinzugefügt wird,
um die Aktualisierung der Oberfläche auszulösen,
ist wesentlich.
Mit der Methode \IC{listen} wird nun sowohl auf den \enquote{Stream} \IC{validityChanged} \Z{57} als auch auf \IC{selectionViewModel} \Z{58} gehorcht. 
Jedes empfangene Ereignis wird dabei dem \IC{BehaviorSubject} \IC{needsRepaint} hinzugefügt.

Dadurch,
dass \IC{needsRepaint} für den \IC{StreamBuilder} verwendet wird \Z{61},
zeichnet sich die Selektionskarte immer dann neu,
wenn sich die beinhaltenden Auswahloptionen oder aber deren Validität ändert.


\begin{alexlisting}{Schritt 5}{Der \enquote{Stream} \enquote{validityChanged} in Schritt 5}
  {Quellcode/Schritt-5/conditional_form/lib/widgets/selection_card.dart}
  {firstline=51, lastline=71, highlightlines={51-58,61}}
  \label{lst:Schritt5needsRepaint}
\end{alexlisting} 

Dieses Verhalten kann auch bei Ausführung der Applikation im Debugmodus in \enquote{Android Studio} beobachtet werden.
Der \enquote{Flutter Performance}-Tab gibt eine Übersicht über die Anzahl der im letzten \enquote{Frame} neu gezeichneten \enquote{Widgets} \Abb{\ref{fig:Schritt51rebuild}}. 
\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-5/1rebuild.png}
  {Das \enquote{Card}-\enquote{Widget} wird einmal neu gezeichnet}
  {Das \enquote{Card}-\enquote{Widget} wird einmal neu gezeichnet}

  \label{fig:Schritt51rebuild}

\end{alexfigure}
Angenommen für die \enquote{Förderklasse} ist \enquote{Agrarumwelt-(und Klima)Maßnahme: nur Vertragsnaturschutz} und für die \enquote{Kategorie} ist \enquote{Düngemanagement} ausgewählt.
Wenn nun für die \enquote{Förderklasse} die Option \enquote{Agrarumwelt-(und Klima)Maßnahmen, tw. auch mit Tierwohlaspekten, aber OHNE Vertragsnaturschutz}  selektiert wird,
so ist im \enquote{Flutter Performance}-Tab zu beobachten,
dass das \enquote{Widget} \IC{Card} nur einmal neu gezeichnet wurde.



Das ergibt Sinn, denn es hat sich nichts an der Validität eines anderen Auswahlfeldes geändert.
Lediglich die Selektionskarte für die Förderklasse muss neu gezeichnet werden,
da sich ihre Selektion angepasst hat.
Wird nun aber die \enquote{Förderklasse} \enquote{Ökolandbau} ausgewählt,
so ist zu beobachten,
dass das \IC{Card}-\enquote{Widget} zweimal gebaut wurde:
Einmal für die Selektionskarte der \enquote{Förderklasse}, da sich deren \enquote{ViewModel} änderte:
Ein weiteres Mal für die Selektionskarte der \enquote{Kategorie},
da die Auswahl \enquote{Düngemanagement} nicht länger valide ist
und die Karte deshalb mit einem roten Hintergrund eingefärbt werden muss \Abb{\ref{fig:Schritt52rebuilds}}.

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-5/2rebuilds.png}
  {Das \enquote{Card}-\enquote{Widget} wird zweimal neu gezeichnet}
  {Das \enquote{Card}-\enquote{Widget} wird zweimal neu gezeichnet}

  \label{fig:Schritt52rebuilds}

\end{alexfigure}

Ohne die Änderungen in diesem Schritt zeigt der \enquote{Flutter Performance}-Tab, dass sich bei jeder Auswahl einer Option sechs \IC{Card}-Elemente aktualisieren \Abb{\ref{fig:Schritt56rebuilds}}.
Das ist der Fall, weil es in Summe sechs Auswahlfelder gibt.

\begin{alexfigure}{Inhalt/Hauptteil/Implementierung/Schritt-5/6rebuilds.png}
  {Das \enquote{Card}-\enquote{Widget} wird siebenmal neu gezeichnet}
  {Das \enquote{Card}-\enquote{Widget} wird siebenmal neu gezeichnet}

  \label{fig:Schritt56rebuilds}

\end{alexfigure}
